<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roam - Remote Maintenance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="app" class="min-h-screen p-6 flex flex-col">
        <header class="mb-6 flex justify-between items-center bg-white p-4 rounded shadow-sm">
            <div class="flex items-center gap-6">
                <h1 class="text-2xl font-bold text-blue-600">{{ t('dashboardTitle') }} <span v-if="serverInfo" class="text-xs text-gray-400 font-normal">v{{ serverInfo.version }}</span></h1>
                <nav class="flex gap-2">
                    <button @click="currentView = 'dashboard'" :class="['px-3 py-1 rounded transition', currentView === 'dashboard' ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100']">{{ t('dashboard') }}</button>
                    <button @click="currentView = 'groups'; fetchGroups()" :class="['px-3 py-1 rounded transition', currentView === 'groups' ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100']">{{ t('groups') }}</button>
                    <button @click="currentView = 'scripts'; fetchScripts()" :class="['px-3 py-1 rounded transition', currentView === 'scripts' ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100']">{{ t('scripts') }}</button>
                    <button @click="currentView = 'history'; fetchHistory()" :class="['px-3 py-1 rounded transition', currentView === 'history' ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100']">{{ t('history') }}</button>
                    <button @click="currentView = 'updates'; fetchUpdates()" :class="['px-3 py-1 rounded transition', currentView === 'updates' ? 'bg-blue-100 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100']">{{ t('updates') }}</button>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-500">{{ t('connectedClients') }}: {{ clients.length }}</span>
                <button @click="toggleLang" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-xs font-medium">
                    {{ t('switchLang') }}
                </button>
            </div>
        </header>

        <!-- Dashboard View -->
        <div v-if="currentView === 'dashboard'" class="bg-white rounded-lg shadow-md overflow-hidden flex-1 flex flex-col">
            <div class="p-4 border-b bg-gray-50 flex gap-4 items-center">
                <div class="relative flex-1 max-w-md">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">üîç</span>
                    <input v-model="searchQuery" type="text" :placeholder="t('searchPlaceholder')" class="w-full border rounded pl-10 pr-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <select v-model="statusFilter" class="border rounded px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="all">{{ t('allStatus') }}</option>
                    <option value="online">{{ t('online') }}</option>
                    <option value="offline">{{ t('offline') }}</option>
                </select>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-gray-50 z-10 shadow-sm">
                        <tr class="text-gray-700 text-sm">
                            <th class="p-4 border-b w-1/6">{{ t('alias') }}</th>
                            <th class="p-4 border-b w-1/6">{{ t('hostname') }}</th>
                            <th class="p-4 border-b w-1/6">{{ t('status') }}</th>
                            <th class="p-4 border-b w-1/6">{{ t('ipAddress') }}</th>
                            <th class="p-4 border-b w-1/6">{{ t('os') }}</th>
                            <th class="p-4 border-b w-1/6">{{ t('version') }}</th>
                            <th class="p-4 border-b">{{ t('actions') }}</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        <tr v-for="client in filteredClients" :key="client.id" class="hover:bg-blue-50 border-b last:border-b-0 transition-colors">
                        <td class="p-4 font-medium">{{ client.alias || '-' }}</td>
                        <td class="p-4">{{ client.hostname }}</td>
                        <td class="p-4">
                            <span :class="{'px-2 py-1 rounded text-xs font-bold': true, 
                                'bg-green-100 text-green-700': client.status === 'online',
                                'bg-gray-100 text-gray-500': client.status === 'offline'
                            }">{{ t(client.status) }}</span>
                        </td>
                        <td class="p-4 font-mono text-gray-500">{{ client.ip }}</td>
                        <td class="p-4">{{ client.os }}</td>
                        <td class="p-4 font-mono text-gray-500">{{ client.version }}</td>
                        <td class="p-4 flex gap-2">
                            <button @click="openHardware(client)" :disabled="client.status === 'offline'" :class="['px-2 py-1 rounded border whitespace-nowrap', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-green-600 hover:bg-green-100 border-green-200']">{{ t('hardware') }}</button>
                            <button @click="openShell(client)" :disabled="client.status === 'offline'" :class="['px-2 py-1 rounded border whitespace-nowrap', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100 border-gray-300']">{{ t('shell') }}</button>
                            <button @click="openFiles(client)" :disabled="client.status === 'offline'" :class="['px-2 py-1 rounded border whitespace-nowrap', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-100 border-blue-200']">{{ t('files') }}</button>
                        </td>
                    </tr>
                    <tr v-if="filteredClients.length === 0">
                        <td colspan="6" class="p-12 text-center text-gray-400 italic">{{ t('noClients') }}</td>
                    </tr>
                </tbody>
            </table>
            </div>
        </div>

        <!-- Groups View -->
        <div v-if="currentView === 'groups'" class="bg-white rounded-lg shadow-md p-6 flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">{{ t('groupManager') }}</h2>
                <button @click="openGroupEditor()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2">
                    <span>+</span> {{ t('createGroup') }}
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="group in groupList" :key="group.id" class="border rounded-lg p-4 hover:shadow-md transition bg-gray-50 flex flex-col">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">{{ group.name }}</h3>
                        <div class="flex gap-1">
                            <button @click="openGroupEditor(group)" class="text-gray-500 hover:text-blue-600 p-1" title="Edit">‚úé</button>
                            <button @click="deleteGroup(group.id)" class="text-gray-500 hover:text-red-600 p-1" title="Delete">üóë</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 mb-4 flex-1">
                        {{ group.client_ids.length }} {{ t('clients') }}
                        <span v-if="group.script_ids && group.script_ids.length > 0" class="ml-2 text-blue-600">
                             ‚Ä¢ {{ group.script_ids.length }} {{ t('boundScripts') }}
                        </span>
                    </div>
                    <div class="mt-2 pt-2 border-t flex justify-end">
                         <button @click="runGroupScripts(group)" class="text-sm bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 shadow-sm flex items-center gap-1">
                            <span>‚ñ∂</span> {{ t('runBoundScripts') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts View -->
        <div v-if="currentView === 'scripts'" class="bg-white rounded-lg shadow-md p-6 flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">{{ t('scriptManager') }}</h2>
                <button @click="openScriptEditor()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2">
                    <span>+</span> {{ t('createScript') }}
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="script in scriptList" :key="script.id" class="border rounded-lg p-4 hover:shadow-md transition bg-gray-50 flex flex-col">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">{{ script.name }}</h3>
                        <div class="flex gap-1">
                            <button @click="openScriptEditor(script)" class="text-gray-500 hover:text-blue-600 p-1" title="Edit">‚úé</button>
                            <button @click="deleteScript(script.id)" class="text-gray-500 hover:text-red-600 p-1" title="Delete">üóë</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 mb-4 flex-1">
                        {{ script.steps.length }} {{ t('steps') }}
                    </div>
                    <button @click="openRunScript(script)" class="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 py-2 rounded font-medium transition">
                        {{ t('runScript') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Updates View -->
        <div v-if="currentView === 'updates'" class="bg-white rounded-lg shadow-md p-6 flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">{{ t('updateManager') }}</h2>
                <button @click="openUploadUpdateModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2">
                    <span>+</span> {{ t('uploadUpdate') }}
                </button>
            </div>
            
            <div class="overflow-auto">
                 <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-700 text-sm">
                            <th class="p-4 border-b">{{ t('version') }}</th>
                            <th class="p-4 border-b">{{ t('platform') }}</th>
                            <th class="p-4 border-b">{{ t('filename') }}</th>
                            <th class="p-4 border-b">{{ t('uploadedAt') }}</th>
                            <th class="p-4 border-b">{{ t('actions') }}</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        <tr v-for="upd in updateList" :key="upd.id" class="hover:bg-blue-50 border-b last:border-b-0 transition-colors">
                            <td class="p-4 font-medium">{{ upd.version }}</td>
                            <td class="p-4">
                                <span :class="{'px-2 py-1 rounded text-xs font-bold': true, 
                                    'bg-blue-100 text-blue-700': upd.platform === 'windows',
                                    'bg-orange-100 text-orange-700': upd.platform === 'linux',
                                    'bg-gray-100 text-gray-700': upd.platform === 'macos'
                                }">{{ upd.platform }}</span>
                            </td>
                            <td class="p-4 font-mono text-gray-500">{{ upd.filename }}</td>
                            <td class="p-4 text-gray-500">{{ new Date(upd.uploaded_at).toLocaleString() }}</td>
                            <td class="p-4 flex gap-2">
                                <button @click="openDeployUpdate(upd)" class="text-green-600 hover:bg-green-100 px-2 py-1 rounded border border-green-200">{{ t('deploy') }}</button>
                                <button @click="deleteUpdate(upd.id)" class="text-red-600 hover:bg-red-100 px-2 py-1 rounded border border-red-200">{{ t('delete') }}</button>
                            </td>
                        </tr>
                        <tr v-if="updateList.length === 0">
                            <td colspan="5" class="p-12 text-center text-gray-400 italic">{{ t('noUpdates') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- History View -->
        <div v-if="currentView === 'history'" class="bg-white rounded-lg shadow-md overflow-hidden flex-1">
             <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-lg">{{ t('executionHistory') }}</h2>
                <div class="flex gap-2">
                    <button @click="clearHistory" class="text-red-600 text-sm hover:underline">{{ t('clearLogs') }}</button>
                    <button @click="fetchHistory" class="text-blue-600 text-sm hover:underline">{{ t('refresh') }}</button>
                </div>
            </div>
            <table class="w-full text-left border-collapse text-sm">
                <thead>
                    <tr class="bg-gray-50 text-gray-700">
                        <th class="p-3 border-b">{{ t('time') }}</th>
                        <th class="p-3 border-b">{{ t('scriptName') }}</th>
                        <th class="p-3 border-b">{{ t('client') }}</th>
                        <th class="p-3 border-b">{{ t('status') }}</th>
                        <th class="p-3 border-b">{{ t('logs') }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in historyList" :key="item.id" class="border-b hover:bg-gray-50">
                        <td class="p-3 font-mono text-xs text-gray-500">{{ new Date(item.started_at).toLocaleString() }}</td>
                        <td class="p-3 font-medium">{{ item.script_name }}</td>
                        <td class="p-3">{{ item.client_hostname }}</td>
                        <td class="p-3">
                            <span :class="{'px-2 py-0.5 rounded-full text-xs font-bold': true, 
                                'bg-green-100 text-green-700': item.status === 'completed',
                                'bg-red-100 text-red-700': item.status === 'failed',
                                'bg-blue-100 text-blue-700': item.status === 'running'
                            }">{{ item.status }}</span>
                        </td>
                        <td class="p-3">
                            <button @click="viewLogs(item)" class="text-blue-600 hover:underline text-xs">{{ t('viewLogs') }}</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Modals -->
        
        <!-- Hardware Info Modal -->
        <div v-if="activeModal === 'hardware'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
                <h3 class="text-xl font-bold mb-4">{{ t('hardwareInfo') }}: {{ selectedClient?.hostname }}</h3>
                <div v-if="commandLoading" class="text-center py-4">{{ t('loading') }}</div>
                <div v-else-if="hardwareInfo" class="space-y-3">
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">{{ t('platform') }}</span>
                        <span class="font-medium">{{ hardwareInfo.platform }}</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">{{ t('cpuUsage') }}</span>
                        <span class="font-medium">{{ hardwareInfo.cpu_usage.toFixed(2) }}%</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">{{ t('totalMemory') }}</span>
                        <span class="font-medium">{{ formatBytes(hardwareInfo.total_memory) }}</span>
                    </div>
                    <div class="flex justify-between pb-2">
                        <span class="text-gray-600">{{ t('usedMemory') }}</span>
                        <span class="font-medium">{{ formatBytes(hardwareInfo.used_memory) }}</span>
                    </div>
                </div>
                <div v-else class="text-red-500">{{ t('failedInfo') }}</div>
                <div class="mt-6 flex justify-end">
                    <button @click="closeModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('close') }}</button>
                </div>
            </div>
        </div>

        <!-- Shell Modal -->
        <div v-if="activeModal === 'shell'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full md:w-1/2 h-[600px]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg">{{ t('remoteShell') }}: {{ selectedClient?.hostname }}</h3>
                    <div class="flex items-center gap-2">
                         <div class="flex items-center bg-white border rounded shadow-sm">
                             <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                                <span v-if="isMaximized">‚ùê</span>
                                <span v-else>‚òê</span>
                            </button>
                            <button @click="closeModal" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                                ‚úï
                            </button>
                         </div>
                    </div>
                </div>
                <div ref="shellOutputRef" class="flex-1 bg-gray-900 text-green-400 p-4 mx-4 mt-4 mb-4 rounded font-mono text-sm overflow-auto whitespace-pre-wrap">{{ shellOutput }}</div>
                <form @submit.prevent="runShellCommand" class="flex gap-2 mx-4 mb-4">
                    <input v-model="shellInput" type="text" :placeholder="t('enterCommand')" class="flex-1 border rounded px-3 py-2 font-mono" autofocus>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">{{ t('run') }}</button>
                    <button type="button" @click="triggerShellUpload" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center gap-1" :title="t('upload')">
                        {{ t('upload') }}
                    </button>
                </form>
                <!-- Hidden file input for shell upload -->
                <input type="file" ref="shellFileInput" class="hidden" @change="handleShellUpload">
            </div>
        </div>

        <!-- Files Modal -->
        <div v-if="activeModal === 'files'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full md:w-1/2 h-[600px]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg">{{ t('fileBrowser') }}: {{ selectedClient?.hostname }}</h3>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                         <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                            <span v-if="isMaximized">‚ùê</span>
                            <span v-else>‚òê</span>
                        </button>
                        <button @click="closeModal" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-2 my-4 mx-4">
                    <input v-model="currentPath" @keyup.enter="listFiles(currentPath)" class="flex-1 border rounded px-2 py-1 text-sm font-mono bg-gray-50">
                    <button @click="listFiles(currentPath)" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Go</button>
                    <button @click="navigateUp" class="bg-gray-300 px-3 py-1 rounded text-sm">Up</button>
                    <button @click="triggerFileUpload" class="bg-green-500 text-white px-3 py-1 rounded text-sm ml-auto">{{ t('uploadToClient') }}</button>
                    <input type="file" ref="fileInput" class="hidden" @change="handleFileUpload">
                </div>
                
                <div class="flex-1 overflow-auto border rounded mx-4 mb-4">
                     <div v-if="commandLoading" class="p-4 text-center text-gray-500">{{ t('loading') }}</div>
                     <table v-else class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">{{ t('name') }}</th>
                                <th class="p-2 text-right">{{ t('size') }}</th>
                                <th class="p-2 text-center">{{ t('type') }}</th>
                                <th class="p-2 text-right">{{ t('action') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="file in fileList" :key="file.name" class="hover:bg-blue-50 cursor-pointer border-b" @click="file.is_dir ? listFiles(joinPath(currentPath, file.name)) : null">
                                <td class="p-2 flex items-center gap-2">
                                    <span v-if="file.is_dir" class="text-yellow-500">üìÅ</span>
                                    <span v-else class="text-gray-400">üìÑ</span>
                                    {{ file.name }}
                                </td>
                                <td class="p-2 text-right font-mono">{{ file.is_dir ? '-' : formatBytes(file.size) }}</td>
                                <td class="p-2 text-center text-xs text-gray-500">{{ file.is_dir ? 'DIR' : 'FILE' }}</td>
                                <td class="p-2 text-right">
                                    <button v-if="!file.is_dir" @click.stop="downloadFromClient(file)" class="text-blue-500 hover:underline text-xs bg-white border px-2 py-0.5 rounded shadow-sm mr-2">{{ t('download') }}</button>
                                    <button v-if="!file.is_dir" @click.stop="openEditor(file)" class="text-gray-700 hover:underline text-xs bg-white border px-2 py-0.5 rounded shadow-sm">{{ t('viewEdit') }}</button>
                                </td>
                            </tr>
                        </tbody>
                     </table>
                </div>
            </div>
        </div>

        <!-- Editor Modal -->
        <div v-if="activeModal === 'editor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full md:w-1/2 h-[600px]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg">{{ t('viewingEditing') }}: {{ editorFile?.name }}</h3>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                         <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                            <span v-if="isMaximized">‚ùê</span>
                            <span v-else>‚òê</span>
                        </button>
                        <button @click="closeEditor" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div v-if="commandLoading" class="flex-1 flex items-center justify-center">{{ t('loading') }}</div>
                <textarea v-else v-model="editorContent" class="flex-1 border rounded p-4 mx-4 my-4 font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                
                <div class="p-4 pt-0 flex justify-end gap-2 mb-2">
                    <button @click="closeEditor" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('closeCancel') }}</button>
                    <button @click="saveFile" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" :disabled="commandLoading">{{ t('saveChanges') }}</button>
                </div>
            </div>
        </div>

        <!-- Group Editor Modal -->
        <div v-if="activeModal === 'groupEditor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ isCreatingGroup ? t('createGroup') : t('editGroup') }}</h3>
                </div>
                <div class="p-6 max-h-[60vh] overflow-auto">
                    <div class="mb-4" v-if="isCreatingGroup">
                        <label class="block text-sm font-bold mb-1">{{ t('groupName') }}</label>
                        <input v-model="newGroup.name" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div v-else>
                        <h4 class="font-bold mb-2">{{ selectedGroup?.name }}</h4>
                    </div>
                    
                    <p class="mb-2 text-sm text-gray-600 font-bold">{{ t('selectClients') }}</p>
                    <div class="space-y-2">
                        <label v-for="client in clients" :key="client.id" class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer border">
                            <input type="checkbox" :value="client.id" v-model="newGroup.client_ids" class="mr-3 h-4 w-4 text-blue-600">
                            <div>
                                <div class="font-medium text-sm">
                                    {{ client.hostname }}
                                    <span v-if="client.alias" class="text-gray-500 font-normal ml-1">({{ client.alias }})</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ client.ip }}</div>
                            </div>
                        </label>
                        <div v-if="clients.length === 0" class="text-center text-gray-400 py-4">{{ t('noClients') }}</div>
                    </div>
                    
                    <div class="mt-4 mb-2">
                        <p class="mb-2 text-sm text-gray-600 font-bold">{{ t('bindScripts') }}</p>
                        <div class="space-y-2 max-h-40 overflow-auto border p-2 rounded bg-gray-50">
                            <label v-for="script in scriptList" :key="script.id" class="flex items-center p-2 hover:bg-white rounded cursor-pointer border border-transparent hover:border-gray-200">
                                <input type="checkbox" :value="script.id" v-model="newGroup.script_ids" class="mr-3 h-4 w-4 text-blue-600">
                                <div class="text-sm font-medium">{{ script.name }}</div>
                            </label>
                            <div v-if="scriptList.length === 0" class="text-center text-gray-400 py-2">{{ t('noScripts') }}</div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="saveGroup" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm">{{ t('save') }}</button>
                </div>
            </div>
        </div>

        <!-- Script Editor Modal -->
        <div v-if="activeModal === 'scriptEditor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl flex flex-col max-h-[90vh]">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ isCreatingScript ? t('createScript') : t('editScript') }}</h3>
                </div>
                <div class="p-6 overflow-auto flex-1">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">{{ t('scriptName') }}</label>
                        <input v-model="newScript.name" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold">{{ t('steps') }}</label>
                            <button @click="addStep" class="text-sm text-blue-600 hover:underline">+ {{ t('addStep') }}</button>
                        </div>
                        
                        <div class="space-y-3">
                            <div v-for="(step, index) in newScript.steps" :key="index" class="border rounded p-3 bg-gray-50 relative group">
                                <button @click="removeStep(index)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">‚úï</button>
                                <div class="flex gap-4 mb-2">
                                    <div class="w-1/4">
                                        <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('stepType') }}</label>
                                        <select v-model="step.type" class="w-full border rounded px-2 py-1 text-sm bg-white">
                                            <option value="Shell">{{ t('shell') }}</option>
                                            <option value="Upload">{{ t('uploadFile') }}</option>
                                            <option value="Download">{{ t('downloadFile') }}</option>
                                            <option value="UploadDir">{{ t('uploadDir') }}</option>
                                            <option value="DownloadDir">{{ t('downloadDir') }}</option>
                                        </select>
                                    </div>
                                    <div class="flex-1">
                                        <div v-if="step.type === 'Shell'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('command') }}</label>
                                            <input v-model="step.cmd" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="e.g. ls">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('args') }}</label>
                                            <input v-model="step.args" class="w-full border rounded px-2 py-1 text-sm" placeholder="e.g. -la /tmp">
                                        </div>
                                        <div v-if="step.type === 'Upload'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('localPath') }}</label>
                                            <input v-model="step.local_path" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="server/uploads/staging/file.txt">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm" placeholder="/tmp/file.txt">
                                        </div>
                                        <div v-if="step.type === 'Download'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm" placeholder="/etc/passwd">
                                        </div>
                                        <div v-if="step.type === 'UploadDir'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('localPath') }}</label>
                                            <input v-model="step.local_path" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="Folder name in staging (e.g. my-app)">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm" placeholder="/opt/my-app">
                                        </div>
                                        <div v-if="step.type === 'DownloadDir'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm" placeholder="/var/log/app">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="saveScript" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm">{{ t('saveScript') }}</button>
                </div>
            </div>
        </div>

        <!-- Run Script Modal -->
        <div v-if="activeModal === 'runScript'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ t('runScript') }}: {{ selectedScript?.name }}</h3>
                </div>
                <div class="p-6 max-h-[60vh] overflow-auto">
                    <p class="mb-4 text-sm text-gray-600">{{ t('selectClients') }}</p>
                    <div class="space-y-2">
                        <label v-for="client in clients" :key="client.id" class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer border">
                            <input type="checkbox" :value="client.id" v-model="selectedClientIds" class="mr-3 h-4 w-4 text-blue-600">
                            <div>
                                <div class="font-medium text-sm">
                                    {{ client.hostname }}
                                    <span v-if="client.alias" class="text-gray-500 font-normal ml-1">({{ client.alias }})</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ client.ip }}</div>
                            </div>
                        </label>
                        <div v-if="clients.length === 0" class="text-center text-gray-400 py-4">{{ t('noClients') }}</div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="executeScript" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 shadow-sm" :disabled="selectedClientIds.length === 0">
                        {{ t('startExecution') }} ({{ selectedClientIds.length }})
                    </button>
                </div>
            </div>
        </div>

        <!-- Log Viewer Modal -->
        <div v-if="activeModal === 'logs'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full max-w-2xl max-h-[80vh]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold">{{ t('executionLogs') }}</h3>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                         <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                            <span v-if="isMaximized">‚ùê</span>
                            <span v-else>‚òê</span>
                        </button>
                        <button @click="closeModal" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                            ‚úï
                        </button>
                    </div>
                </div>
                <div class="p-4 overflow-auto bg-gray-900 text-green-400 font-mono text-xs flex-1">
                    <div v-for="(log, i) in selectedLogs" :key="i" class="mb-1">{{ log }}</div>
                </div>
            </div>
        </div>

        <!-- Execution Monitor Modal -->
        <div v-if="activeModal === 'executionMonitor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl flex flex-col max-h-[90vh] relative">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="font-bold text-lg">{{ t('executionMonitor') }}</h3>
                    <button @click="closeModal" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
                <div class="p-4 overflow-auto flex-1 bg-gray-50">
                    <table class="w-full text-left text-sm border-collapse bg-white shadow-sm rounded">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 border-b">{{ t('client') }}</th>
                                <th class="p-3 border-b">{{ t('scriptName') }}</th>
                                <th class="p-3 border-b">{{ t('status') }}</th>
                                <th class="p-3 border-b">{{ t('progress') }}</th>
                                <th class="p-3 border-b">{{ t('latestLog') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="exec in executionList" :key="exec.execution_id" class="border-b">
                                <td class="p-3 font-medium">{{ exec.client_hostname }}</td>
                                <td class="p-3">{{ exec.script_name }}</td>
                                <td class="p-3">
                                    <span :class="{'px-2 py-0.5 rounded-full text-xs font-bold': true, 
                                        'bg-green-100 text-green-700': exec.status === 'completed',
                                        'bg-red-100 text-red-700': exec.status === 'failed',
                                        'bg-blue-100 text-blue-700': exec.status === 'running'
                                    }">{{ exec.status }}</span>
                                </td>
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-20 bg-gray-200 rounded-full h-2.5">
                                            <div class="bg-blue-600 h-2.5 rounded-full" :style="{ width: (exec.current_step / exec.total_steps * 100) + '%' }"></div>
                                        </div>
                                        <span class="text-xs text-gray-500">{{ exec.current_step }}/{{ exec.total_steps }}</span>
                                    </div>
                                </td>
                                <td class="p-3 font-mono text-xs text-gray-500 max-w-xs">
                                    <div class="flex justify-between items-center">
                                        <span class="truncate block max-w-[150px]" :title="exec.logs[exec.logs.length-1]">{{ exec.logs[exec.logs.length-1] || '-' }}</span>
                                        <button @click="viewingExecutionId = exec.execution_id" class="text-blue-600 hover:underline ml-2 whitespace-nowrap">{{ t('viewLogs') }}</button>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="executionList.length === 0">
                                <td colspan="5" class="p-8 text-center text-gray-400">{{ t('noActiveExecutions') }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Live Logs Overlay -->
                <div v-if="viewingExecutionId" class="absolute inset-0 bg-white bg-opacity-95 flex flex-col z-10 p-4">
                     <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h4 class="font-bold">{{ t('liveLogs') }}: {{ viewingExecution?.client_hostname }} - {{ viewingExecution?.script_name }}</h4>
                        <button @click="viewingExecutionId = null" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm">{{ t('back') }}</button>
                    </div>
                    <div class="flex-1 overflow-auto bg-gray-900 text-green-400 font-mono text-xs p-4 rounded">
                         <div v-if="viewingExecution">
                            <div v-for="(log, i) in viewingExecution.logs" :key="i" class="mb-1 whitespace-pre-wrap">{{ log }}</div>
                         </div>
                         <div v-else class="text-gray-500">Execution finished or not found.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Update Modal -->
        <div v-if="activeModal === 'uploadUpdate'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
                <h3 class="text-xl font-bold mb-4">{{ t('uploadUpdatePackage') }}</h3>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('version') }}</label>
                    <input v-model="newUpdate.version" type="text" placeholder="e.g. 1.0.1" class="w-full border rounded px-3 py-2">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('platform') }}</label>
                    <select v-model="newUpdate.platform" class="w-full border rounded px-3 py-2 bg-white">
                        <option value="windows">Windows</option>
                        <option value="linux">Linux</option>
                        <option value="macos">macOS</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('file') }}</label>
                    <input type="file" ref="updateFileInput" class="w-full border rounded px-3 py-2">
                </div>

                <div class="flex justify-end gap-2">
                    <button @click="closeModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('cancel') }}</button>
                    <button @click="uploadUpdate" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" :disabled="commandLoading">
                        {{ commandLoading ? t('uploading') : t('upload') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Deploy Update Modal -->
        <div v-if="activeModal === 'deployUpdate'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ t('deployUpdate') }}: {{ selectedUpdate?.version }}</h3>
                </div>
                <div class="p-6 max-h-[60vh] overflow-auto">
                    <p class="mb-4 text-sm text-gray-600">{{ t('selectClientsToUpdate') }}</p>
                    <div class="space-y-2">
                        <label v-for="client in clients" :key="client.id" class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer border">
                            <input type="checkbox" :value="client.id" v-model="selectedClientIds" class="mr-3 h-4 w-4 text-blue-600">
                            <div>
                                <div class="font-medium text-sm">
                                    {{ client.hostname }}
                                    <span v-if="client.alias" class="text-gray-500 font-normal ml-1">({{ client.alias }})</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ client.ip }} - {{ client.os }}</div>
                            </div>
                        </label>
                        <div v-if="clients.length === 0" class="text-center text-gray-400 py-4">{{ t('noClients') }}</div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="triggerDeploy" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 shadow-sm" :disabled="selectedClientIds.length === 0">
                        {{ t('startUpdate') }} ({{ selectedClientIds.length }})
                    </button>
                </div>
            </div>
        </div>


    </div>

    <script>
        const { createApp, ref, onMounted, watch, nextTick, computed } = Vue

        createApp({
            setup() {
                const clients = ref([])
                const serverInfo = ref(null)
                const currentView = ref('dashboard')
                const activeModal = ref(null)
                const selectedClient = ref(null)
                const commandLoading = ref(false)

                // Dashboard Filter
                const searchQuery = ref('')
                const statusFilter = ref('all')

                const filteredClients = computed(() => {
                    return clients.value.filter(client => {
                        const q = searchQuery.value.toLowerCase()
                        const matchQuery = !q || 
                            (client.hostname && client.hostname.toLowerCase().includes(q)) ||
                            (client.alias && client.alias.toLowerCase().includes(q)) ||
                            (client.ip && client.ip.includes(q)) ||
                            (client.version && client.version.includes(q))
                        
                        const matchStatus = statusFilter.value === 'all' || client.status === statusFilter.value
                        
                        return matchQuery && matchStatus
                    })
                })
                
                // Hardware Info
                const hardwareInfo = ref(null)

                // Shell
                const shellInput = ref('')
                const shellOutput = ref('')
                const shellOutputRef = ref(null)
                const shellFileInput = ref(null)

                watch(shellOutput, async () => {
                    await nextTick()
                    if (shellOutputRef.value) {
                        shellOutputRef.value.scrollTop = shellOutputRef.value.scrollHeight
                    }
                })

                // Files
                const currentPath = ref('.')
                const fileList = ref([])
                const fileInput = ref(null)
                
                // Editor
                const editorFile = ref(null)
                const editorContent = ref('')

                // Groups
                const groupList = ref([])
                const selectedGroup = ref(null)
                const isCreatingGroup = ref(false)
                const newGroup = ref({ name: '', client_ids: [], script_ids: [] })

                // Scripts
                const scriptList = ref([])
                const selectedScript = ref(null)
                const isCreatingScript = ref(false)
                const newScript = ref({ name: '', steps: [] })
                const scriptStatus = ref(null)
                const selectedClientIds = ref([])

                // History
                const historyList = ref([])
                const selectedLogs = ref([])
                const executionList = ref([])
                const viewingExecutionId = ref(null)
                const viewingExecution = computed(() => executionList.value.find(e => e.execution_id === viewingExecutionId.value))
                let executionPollTimer = null

                // Updates
                const updateList = ref([])
                const selectedUpdate = ref(null)
                const newUpdate = ref({ version: '', platform: 'windows' })
                const updateFileInput = ref(null)

                // Layout
                const isMaximized = ref(false)
                
                const toggleMaximize = () => {
                    isMaximized.value = !isMaximized.value
                }

                // I18n
                const lang = ref('zh')
                const messages = {
                    en: {
                        dashboardTitle: 'Roam Dashboard',
                        connectedClients: 'Connected Clients',
                        alias: 'Alias',
                        hostname: 'Hostname',
                        ipAddress: 'IP Address',
                        os: 'OS',
                        version: 'Version',
                        id: 'ID',
                        actions: 'Actions',
                        noClients: 'No clients connected.',
                        hardware: 'Hardware',
                        shell: 'Shell',
                        files: 'Files',
                        update: 'Update',
                        hardwareInfo: 'Hardware Info',
                        loading: 'Loading...',
                        platform: 'Platform',
                        cpuUsage: 'CPU Usage',
                        totalMemory: 'Total Memory',
                        usedMemory: 'Used Memory',
                        failedInfo: 'Failed to fetch info or no data yet',
                        close: 'Close',
                        remoteShell: 'Remote Shell',
                        maximize: 'Maximize',
                        restore: 'Restore',
                        enterCommand: 'Enter command (e.g. ls -la)',
                        run: 'Run',
                        fileBrowser: 'File Browser',
                        uploadToClient: 'Upload to Client',
                        name: 'Name',
                        size: 'Size',
                        type: 'Type',
                        action: 'Action',
                        download: 'Download',
                        viewEdit: 'View/Edit',
                        viewingEditing: 'Viewing/Editing',
                        closeCancel: 'Close/Cancel',
                        saveChanges: 'Save Changes',
                        updateClient: 'Update Client',
                        currentVersion: 'Current Version',
                        updateUrl: 'Update URL',
                        cancel: 'Cancel',
                        startUpdate: 'Start Update',
                        updating: 'Updating...',
                        switchLang: '‰∏≠Êñá',
                        scripts: 'Scripts',
                        scriptManager: 'Script Manager',
                        createScript: 'Create Script',
                        scriptName: 'Script Name',
                        steps: 'Steps',
                        addStep: 'Add Step',
                        stepType: 'Type',
                        command: 'Command',
                        args: 'Arguments (space separated)',
                        localPath: 'Local Path (Server)',
                        remotePath: 'Remote Path (Client)',
                        remove: 'Remove',
                        saveScript: 'Save Script',
                        runScript: 'Run Script',
                        selectScript: 'Select Script to Run',
                        running: 'Running...',
                        scriptStarted: 'Script execution started',
                        dashboard: 'Dashboard',
                        history: 'History',
                        executionHistory: 'Execution History',
                        time: 'Time',
                        client: 'Client',
                        logs: 'Logs',
                        selectClients: 'Select Clients to Execute Script',
                        startExecution: 'Start Execution',
                        editScript: 'Edit Script',
                        runScript: 'Run Script',
                        stepType: 'Step Type',
                        localPath: 'Local Path (Server)',
                        remotePath: 'Remote Path (Client)',
                        args: 'Arguments',
                        cancel: 'Cancel',
                        saveScript: 'Save Script',
                        executionLogs: 'Execution Logs',
                        selectClients: 'Select Clients',
                        clearLogs: 'Clear Logs',
                        logsCleared: 'Logs cleared successfully',
                        refresh: 'Refresh',
                        upload: 'Upload',
                        online: 'Online',
                        offline: 'Offline',
                        groups: 'Groups',
                        groupManager: 'Group Manager',
                        createGroup: 'Create Group',
                        groupName: 'Group Name',
                        editGroup: 'Edit Group',
                        clients: 'Clients',
                        save: 'Save',
                        bindScripts: 'Bind Script Groups',
                        boundScripts: 'Scripts',
                        runBoundScripts: 'Run Scripts',
                        noScripts: 'No scripts available',
                        executionMonitor: 'Execution Monitor',
                        noActiveExecutions: 'No active executions',
                        progress: 'Progress',
                        latestLog: 'Latest Log',
                        confirmRunGroup: 'Are you sure you want to run bound scripts for this group?',
                        executionStarted: 'Execution started',
                        viewLogs: 'View Logs',
                        liveLogs: 'Live Logs',
                        back: 'Back',
                        updateManager: 'Update Manager',
                        uploadUpdate: 'Upload Update',
                        version: 'Version',
                        platform: 'Platform',
                        filename: 'Filename',
                        uploadedAt: 'Uploaded At',
                        noUpdates: 'No update packages found.',
                        deploy: 'Deploy',
                        delete: 'Delete',
                        uploadUpdatePackage: 'Upload Update Package',
                        file: 'File',
                        uploading: 'Uploading...',
                        deployUpdate: 'Deploy Update',
                        selectClientsToUpdate: 'Select Clients to Update',
                        startUpdate: 'Start Update',
                        uploadFile: 'Upload File',
                        downloadFile: 'Download File',
                        uploadDir: 'Upload Directory',
                        downloadDir: 'Download Directory',
                        updates: 'Updates',
                        searchPlaceholder: 'Search hostname, alias, IP...',
                        allStatus: 'All Status',
                    },
                    zh: {
                        dashboardTitle: 'Roam ÊéßÂà∂Âè∞',
                        connectedClients: 'Â∑≤ËøûÊé•ÂÆ¢Êà∑Á´Ø',
                        alias: 'Âà´Âêç',
                        hostname: '‰∏ªÊú∫Âêç',
                        ipAddress: 'IP Âú∞ÂùÄ',
                        os: 'Êìç‰ΩúÁ≥ªÁªü',
                        version: 'ÁâàÊú¨',
                        id: 'ID',
                        actions: 'Êìç‰Ωú',
                        noClients: 'ÊöÇÊó†ÂÆ¢Êà∑Á´ØËøûÊé•',
                        hardware: 'Á°¨‰ª∂‰ø°ÊÅØ',
                        shell: 'ÁªàÁ´Ø',
                        files: 'Êñá‰ª∂ÁÆ°ÁêÜ',
                        update: 'Êõ¥Êñ∞',
                        hardwareInfo: 'Á°¨‰ª∂‰ø°ÊÅØ',
                        loading: 'Âä†ËΩΩ‰∏≠...',
                        platform: 'Âπ≥Âè∞',
                        cpuUsage: 'CPU ‰ΩøÁî®Áéá',
                        totalMemory: 'ÊÄªÂÜÖÂ≠ò',
                        usedMemory: 'Â∑≤Áî®ÂÜÖÂ≠ò',
                        failedInfo: 'Ëé∑Âèñ‰ø°ÊÅØÂ§±Ë¥•ÊàñÊöÇÊó†Êï∞ÊçÆ',
                        close: 'ÂÖ≥Èó≠',
                        remoteShell: 'ËøúÁ®ãÁªàÁ´Ø',
                        maximize: 'ÊúÄÂ§ßÂåñ',
                        restore: 'ËøòÂéü',
                        enterCommand: 'ËæìÂÖ•ÂëΩ‰ª§ (Â¶Ç ls -la)',
                        run: 'ËøêË°å',
                        fileBrowser: 'Êñá‰ª∂ÊµèËßà',
                        uploadToClient: '‰∏ä‰º†Âà∞ÂÆ¢Êà∑Á´Ø',
                        name: 'ÂêçÁß∞',
                        size: 'Â§ßÂ∞è',
                        type: 'Á±ªÂûã',
                        action: 'Êìç‰Ωú',
                        download: '‰∏ãËΩΩ',
                        viewEdit: 'Êü•Áúã/ÁºñËæë',
                        viewingEditing: 'Ê≠£Âú®Êü•Áúã/ÁºñËæë',
                        closeCancel: 'ÂÖ≥Èó≠/ÂèñÊ∂à',
                        saveChanges: '‰øùÂ≠òÊõ¥Êîπ',
                        updateClient: 'Êõ¥Êñ∞ÂÆ¢Êà∑Á´Ø',
                        currentVersion: 'ÂΩìÂâçÁâàÊú¨',
                        updateUrl: 'Êõ¥Êñ∞ÈìæÊé•',
                        cancel: 'ÂèñÊ∂à',
                        startUpdate: 'ÂºÄÂßãÊõ¥Êñ∞',
                        updating: 'Êõ¥Êñ∞‰∏≠...',
                        switchLang: 'English',
                        scripts: 'ËÑöÊú¨ÁªÑ',
                        scriptManager: 'ËÑöÊú¨ÁªÑÁÆ°ÁêÜ',
                        createScript: 'ÂàõÂª∫ËÑöÊú¨ÁªÑ',
                        scriptName: 'ËÑöÊú¨ÂêçÁß∞',
                        steps: 'Ê≠•È™§',
                        addStep: 'Ê∑ªÂä†Ê≠•È™§',
                        stepType: 'Á±ªÂûã',
                        command: 'ÂëΩ‰ª§',
                        args: 'ÂèÇÊï∞ (Á©∫Ê†ºÂàÜÈöî)',
                        localPath: 'Êú¨Âú∞Ë∑ØÂæÑ (ÊúçÂä°Á´Ø)',
                        remotePath: 'ËøúÁ®ãË∑ØÂæÑ (ÂÆ¢Êà∑Á´Ø)',
                        remove: 'ÁßªÈô§',
                        saveScript: '‰øùÂ≠òËÑöÊú¨',
                        runScript: 'ËøêË°åËÑöÊú¨',
                        selectScript: 'ÈÄâÊã©Ë¶ÅËøêË°åÁöÑËÑöÊú¨',
                        running: 'ËøêË°å‰∏≠...',
                        scriptStarted: 'ËÑöÊú¨ÊâßË°åÂ∑≤ÂºÄÂßã',
                        dashboard: '‰ª™Ë°®Áõò',
                        history: 'ÂéÜÂè≤ËÆ∞ÂΩï',
                        executionHistory: 'ÊâßË°åÂéÜÂè≤',
                        time: 'Êó∂Èó¥',
                        client: 'ÂÆ¢Êà∑Á´Ø',
                        logs: 'Êó•Âøó',
                        selectClients: 'ÈÄâÊã©Ë¶ÅÊâßË°åËÑöÊú¨ÁöÑÂÆ¢Êà∑Á´Ø',
                        startExecution: 'ÂºÄÂßãÊâßË°å',
                        editScript: 'ÁºñËæëËÑöÊú¨',
                        runScript: 'ËøêË°åËÑöÊú¨',
                        stepType: 'Ê≠•È™§Á±ªÂûã',
                        localPath: 'Êú¨Âú∞Ë∑ØÂæÑ (ÊúçÂä°Á´Ø)',
                        remotePath: 'ËøúÁ®ãË∑ØÂæÑ (ÂÆ¢Êà∑Á´Ø)',
                        args: 'ÂèÇÊï∞',
                        cancel: 'ÂèñÊ∂à',
                        saveScript: '‰øùÂ≠òËÑöÊú¨',
                        executionLogs: 'ÊâßË°åÊó•Âøó',
                        selectClients: 'ÈÄâÊã©ÂÆ¢Êà∑Á´Ø',
                        clearLogs: 'Ê∏ÖÁ©∫Êó•Âøó',
                        logsCleared: 'Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫',
                        refresh: 'Âà∑Êñ∞',
                        upload: '‰∏ä‰º†',
                        online: 'Âú®Á∫ø',
                        offline: 'Á¶ªÁ∫ø',
                        status: 'Áä∂ÊÄÅ',
                        groups: 'ÂÆ¢Êà∑Á´ØÂàÜÁªÑ',
                        groupManager: 'ÂàÜÁªÑÁÆ°ÁêÜ',
                        createGroup: 'ÂàõÂª∫ÂàÜÁªÑ',
                        groupName: 'ÂàÜÁªÑÂêçÁß∞',
                        editGroup: 'ÁºñËæëÂàÜÁªÑ',
                        clients: 'ÂÆ¢Êà∑Á´Ø',
                        save: '‰øùÂ≠ò',
                        bindScripts: 'ÁªëÂÆöËÑöÊú¨ÁªÑ',
                        boundScripts: '‰∏™ËÑöÊú¨',
                        runBoundScripts: 'ÊâßË°åËÑöÊú¨',
                        noScripts: 'ÊöÇÊó†ËÑöÊú¨',
                        executionMonitor: 'ÊâßË°åÁõëÊéß',
                        noActiveExecutions: 'ÊöÇÊó†Ê¥ªÂä®ÊâßË°å‰ªªÂä°',
                        progress: 'ËøõÂ∫¶',
                        latestLog: 'ÊúÄÊñ∞Êó•Âøó',
                        confirmRunGroup: 'Á°ÆÂÆöË¶Å‰∏∫ËØ•ÂàÜÁªÑÊâßË°åÊâÄÊúâÁªëÂÆöÁöÑËÑöÊú¨ÂêóÔºü',
                        executionStarted: 'ÊâßË°åÂ∑≤ÂºÄÂßã',
                        viewLogs: 'Êü•ÁúãÊó•Âøó',
                        liveLogs: 'ÂÆûÊó∂Êó•Âøó',
                        back: 'ËøîÂõû',
                        updateManager: 'Êõ¥Êñ∞ÁÆ°ÁêÜ',
                        uploadUpdate: '‰∏ä‰º†Êõ¥Êñ∞ÂåÖ',
                        version: 'ÁâàÊú¨',
                        platform: 'Âπ≥Âè∞',
                        filename: 'Êñá‰ª∂Âêç',
                        uploadedAt: '‰∏ä‰º†Êó∂Èó¥',
                        noUpdates: 'ÊöÇÊó†Êõ¥Êñ∞ÂåÖ',
                        deploy: 'ÈÉ®ÁΩ≤',
                        delete: 'Âà†Èô§',
                        uploadUpdatePackage: '‰∏ä‰º†Êõ¥Êñ∞ÂåÖ',
                        file: 'Êñá‰ª∂',
                        uploading: '‰∏ä‰º†‰∏≠...',
                        deployUpdate: 'ÈÉ®ÁΩ≤Êõ¥Êñ∞',
                        selectClientsToUpdate: 'ÈÄâÊã©Ë¶ÅÊõ¥Êñ∞ÁöÑÂÆ¢Êà∑Á´Ø',
                        startUpdate: 'ÂºÄÂßãÊõ¥Êñ∞',
                        uploadFile: '‰∏ä‰º†Êñá‰ª∂',
                        downloadFile: '‰∏ãËΩΩÊñá‰ª∂',
                        uploadDir: '‰∏ä‰º†Êñá‰ª∂Â§π',
                        downloadDir: '‰∏ãËΩΩÊñá‰ª∂Â§π',
                        updates: 'Êõ¥Êñ∞ÁÆ°ÁêÜ',
                        searchPlaceholder: 'ÊêúÁ¥¢‰∏ªÊú∫Âêç„ÄÅÂà´Âêç„ÄÅIP...',
                        allStatus: 'ÂÖ®ÈÉ®Áä∂ÊÄÅ',
                    }
                }

                const t = (key) => {
                    const val = messages[lang.value][key]
                    if (!val) {
                        // Fallback to English if translation missing
                        return messages['en'][key] || key
                    }
                    return val
                }

                const toggleLang = () => {
                    lang.value = lang.value === 'en' ? 'zh' : 'en'
                }

                const fetchClients = async () => {
                    try {
                        const res = await fetch('/api/clients')
                        clients.value = await res.json()
                    } catch (e) {
                        console.error(e)
                    }
                }

                const fetchServerInfo = async () => {
                    try {
                        const res = await fetch('/api/info')
                        if (res.ok) {
                            serverInfo.value = await res.json()
                        }
                    } catch (e) {
                        console.error(e)
                    }
                }

                // Polling for client list
                setInterval(fetchClients, 5000)
                onMounted(() => {
                    fetchClients()
                    fetchServerInfo()
                })

                const pollResult = async (cmdId) => {
                    const maxRetries = 600; // 5 minutes
                    for (let i = 0; i < maxRetries; i++) {
                        try {
                            const res = await fetch(`/api/commands/${cmdId}/result`);
                            if (res.ok) {
                                const result = await res.json();
                                return result;
                            }
                        } catch (e) {}
                        await new Promise(r => setTimeout(r, 500));
                    }
                    throw new Error("Command timed out");
                };

                const sendCommand = async (clientId, payload, waitForResult = true) => {
                    commandLoading.value = true
                    try {
                        const res = await fetch(`/api/clients/${clientId}/command`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cmd: payload })
                        })
                        if (!res.ok) throw new Error('Command failed to send')
                        const cmdId = await res.text()
                        
                        if (!waitForResult) return { status: 'Sent', id: cmdId };

                        // Poll for result
                        const result = await pollResult(cmdId);
                        
                        // Handle Result Types
                        if (result.status === 'Error') {
                            throw new Error(result.data);
                        }
                        
                        return result;
                    } catch (e) {
                        console.error(e)
                        throw e // Propagate error
                    } finally {
                        commandLoading.value = false
                    }
                }

                const openHardware = async (client) => {
                    selectedClient.value = client
                    activeModal.value = 'hardware'
                    hardwareInfo.value = null
                    try {
                        const result = await sendCommand(client.id, { cmd_type: 'GetHardwareInfo' })
                        if (result && result.status === 'HardwareInfo') {
                            hardwareInfo.value = result.data
                        }
                    } catch (e) {
                        // Error handled in UI via v-else
                    }
                }

                const openShell = (client) => {
                    selectedClient.value = client
                    activeModal.value = 'shell'
                    shellOutput.value = 'Ready to execute commands...'
                    shellInput.value = ''
                    isMaximized.value = false
                }

                const runShellCommand = async () => {
                    if (!shellInput.value.trim()) return
                    const cmd = shellInput.value.trim()
                    const parts = cmd.split(' ')
                    const command = parts[0]
                    const args = parts.slice(1)
                    
                    shellOutput.value += `\n> ${cmd}\n`
                    
                    try {
                        const result = await sendCommand(selectedClient.value.id, { 
                            cmd_type: 'ShellExec', 
                            args: { cmd: command, args: args } 
                        })
                        
                        if (result && result.status === 'ShellOutput') {
                            shellOutput.value += result.data.stdout + result.data.stderr;
                        } else if (result && result.status === 'Error') {
                            shellOutput.value += `Error: ${result.data}\n`;
                        }
                    } catch (e) {
                        shellOutput.value += `Error: ${e.message}\n`;
                    }
                    
                    shellInput.value = ''
                }

                const triggerShellUpload = () => {
                    shellFileInput.value.click()
                }

                const handleShellUpload = async (event) => {
                    const file = event.target.files[0]
                    if (!file) return
                    
                    const formData = new FormData()
                    formData.append('file', file)
                    
                    shellOutput.value += `\n> Uploading ${file.name}...\n`
                    
                    try {
                        const res = await fetch('/api/files/admin-upload', {
                            method: 'POST',
                            body: formData
                        })
                        if (!res.ok) throw new Error('Server upload failed')
                        const data = await res.json()
                        const downloadUrl = data.url
                        
                        // Use relative path (filename only) to upload to current shell directory
                        const destPath = file.name
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'DownloadFile',
                            args: { url: downloadUrl, dest_path: destPath }
                        })
                        
                        if (result && result.status === 'Success') {
                            shellOutput.value += `Success: File uploaded to current directory.\n`
                        } else {
                            throw new Error(result.data || 'Client failed to download')
                        }
                    } catch (e) {
                        shellOutput.value += `Error: Upload failed: ${e.message}\n`
                    } finally {
                        event.target.value = ''
                    }
                }

                const openFiles = (client) => {
                    selectedClient.value = client
                    activeModal.value = 'files'
                    currentPath.value = '.'
                    listFiles('.')
                    isMaximized.value = false
                }

                const listFiles = async (path) => {
                    currentPath.value = path
                    fileList.value = []
                    try {
                        const result = await sendCommand(selectedClient.value.id, { 
                            cmd_type: 'ListDir', 
                            args: { path: path } 
                        })
                        
                        if (result && result.status === 'FileList') {
                            fileList.value = result.data.files.sort((a, b) => {
                                if (a.is_dir === b.is_dir) return a.name.localeCompare(b.name);
                                return a.is_dir ? -1 : 1;
                            });
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const triggerFileUpload = () => {
                    fileInput.value.click()
                }

                const handleFileUpload = async (event) => {
                    const file = event.target.files[0]
                    if (!file) return
                    
                    const formData = new FormData()
                    formData.append('file', file)
                    
                    commandLoading.value = true
                    try {
                        const res = await fetch('/api/files/admin-upload', {
                            method: 'POST',
                            body: formData
                        })
                        if (!res.ok) throw new Error('Server upload failed')
                        const data = await res.json()
                        const downloadUrl = data.url
                        
                        const destPath = joinPath(currentPath.value, file.name)
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'DownloadFile',
                            args: { url: downloadUrl, dest_path: destPath }
                        })
                        
                        if (result && result.status === 'Success') {
                            alert('File uploaded to client successfully!')
                            listFiles(currentPath.value)
                        } else {
                            throw new Error(result.data || 'Client failed to download')
                        }
                    } catch (e) {
                        alert('Upload failed: ' + e.message)
                    } finally {
                        commandLoading.value = false
                        event.target.value = ''
                    }
                }

                const downloadFromClient = async (file) => {
                    if (!confirm(`Download ${file.name}?`)) return
                    
                    try {
                        const uploadId = crypto.randomUUID();
                        const host = window.location.host;
                        const uploadUrl = `http://${host}/api/files/client-upload/${uploadId}`;
                        
                        const srcPath = joinPath(currentPath.value, file.name);
                        
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'UploadFile',
                            args: { src_path: srcPath, upload_url: uploadUrl }
                        });
                        
                        if (result && result.status === 'Success') {
                             const serverDownloadUrl = `/api/files/download/client_data/${uploadId}/${file.name}`;
                             window.open(serverDownloadUrl, '_blank');
                        } else {
                             alert('Download failed: ' + (result?.data || 'Unknown error'));
                        }
                        
                    } catch (e) {
                        alert('Download failed: ' + e.message);
                    }
                }

                const openEditor = async (file) => {
                    editorFile.value = file;
                    editorContent.value = '';
                    activeModal.value = 'editor';
                    isMaximized.value = false;
                    
                    try {
                        const filePath = joinPath(currentPath.value, file.name);
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'ReadFile',
                            args: { path: filePath }
                        });
                        
                        if (result && result.status === 'FileContent') {
                            editorContent.value = result.data.content;
                        } else {
                            alert('Failed to read file: ' + (result?.data || 'Unknown error'));
                            closeEditor();
                        }
                    } catch (e) {
                        alert('Error opening file: ' + e.message);
                        closeEditor();
                    }
                }

                const closeEditor = () => {
                    activeModal.value = 'files'; // Go back to files
                    editorFile.value = null;
                }

                const saveFile = async () => {
                    if (!editorFile.value) return;
                    
                    try {
                        const filePath = joinPath(currentPath.value, editorFile.value.name);
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'WriteFile',
                            args: { path: filePath, content: editorContent.value }
                        });
                        
                        if (result && result.status === 'Success') {
                            alert('File saved successfully!');
                            closeEditor();
                            listFiles(currentPath.value); // Refresh
                        } else {
                            alert('Failed to save file: ' + (result?.data || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Error saving file: ' + e.message);
                    }
                }

                const openScripts = async () => {
                     // No-op, used by tab
                }

                const fetchScripts = async () => {
                    try {
                        const res = await fetch('/api/scripts')
                        if (res.ok) {
                            scriptList.value = await res.json()
                        }
                    } catch (e) {
                        console.error('Failed to fetch scripts', e)
                    }
                }

                const fetchGroups = async () => {
                    try {
                        const res = await fetch('/api/groups')
                        if (res.ok) {
                            groupList.value = await res.json()
                        }
                    } catch (e) {
                        console.error('Failed to fetch groups', e)
                    }
                }

                const startExecutionPolling = () => {
                    stopExecutionPolling()
                    executionPollTimer = setInterval(async () => {
                        if (activeModal.value !== 'executionMonitor') {
                            stopExecutionPolling()
                            return
                        }
                        try {
                            const res = await fetch('/api/executions/active')
                            if (res.ok) {
                                executionList.value = await res.json()
                            }
                        } catch (e) {
                            console.error(e)
                        }
                    }, 1000)
                }

                const stopExecutionPolling = () => {
                    if (executionPollTimer) {
                        clearInterval(executionPollTimer)
                        executionPollTimer = null
                    }
                }

                const runGroupScripts = async (group) => {
                    if (!confirm(t('confirmRunGroup'))) return
                    
                    try {
                        const res = await fetch(`/api/groups/${group.id}/run`, { method: 'POST' })
                        if (res.ok) {
                            alert(t('executionStarted'))
                            activeModal.value = 'executionMonitor'
                            executionList.value = []
                            startExecutionPolling()
                        } else {
                            const txt = await res.text()
                            alert('Failed: ' + txt)
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const openGroupEditor = (group = null) => {
                    activeModal.value = 'groupEditor'
                    fetchScripts() // Ensure scripts are loaded
                    if (group) {
                        isCreatingGroup.value = false
                        selectedGroup.value = group
                        newGroup.value = { 
                            name: group.name, // Name is not editable in update, only members
                            client_ids: [...group.client_ids],
                            script_ids: group.script_ids ? [...group.script_ids] : []
                        }
                    } else {
                        isCreatingGroup.value = true
                        selectedGroup.value = null
                        newGroup.value = { name: '', client_ids: [], script_ids: [] }
                    }
                }

                const saveGroup = async () => {
                    try {
                        let res;
                        if (isCreatingGroup.value) {
                            if (!newGroup.value.name) return alert('Name required')
                            
                            // 1. Create Group
                            res = await fetch('/api/groups', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name: newGroup.value.name })
                            })
                            
                            if (res.ok) {
                                const data = await res.json()
                                // 2. Update Members & Scripts
                                const updates = {}
                                if (newGroup.value.client_ids.length > 0) updates.client_ids = newGroup.value.client_ids
                                if (newGroup.value.script_ids.length > 0) updates.script_ids = newGroup.value.script_ids
                                
                                if (Object.keys(updates).length > 0) {
                                    await fetch(`/api/groups/${data.id}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(updates)
                                    })
                                }
                            }
                        } else {
                            // Update Members & Scripts
                            const updates = {
                                client_ids: newGroup.value.client_ids,
                                script_ids: newGroup.value.script_ids
                            }
                            res = await fetch(`/api/groups/${selectedGroup.value.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updates)
                            })
                        }
                        
                        if (res.ok) {
                            await fetchGroups()
                            closeModal()
                        } else {
                            alert('Failed to save group')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const deleteGroup = async (id) => {
                    if (!confirm('Are you sure you want to delete this group?')) return;
                    try {
                        const res = await fetch(`/api/groups/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            await fetchGroups();
                        } else {
                            alert('Failed to delete group');
                        }
                    } catch (e) {
                        alert(e.message);
                    }
                }

                const openScriptEditor = (script = null) => {
                    activeModal.value = 'scriptEditor'
                    if (script) {
                        isCreatingScript.value = false
                        selectedScript.value = script
                        // Deep copy to avoid modifying original until saved
                        const rawScript = JSON.parse(JSON.stringify(script))
                        
                        // Transform steps from payload format to flat format for UI
                        const steps = rawScript.steps.map(s => {
                            if (s.type === 'Shell') {
                                return { type: 'Shell', cmd: s.payload.cmd, args: s.payload.args.join(' ') }
                            } else if (s.type === 'Upload') {
                                return { type: 'Upload', local_path: s.payload.local_path, remote_path: s.payload.remote_path }
                            } else if (s.type === 'Download') {
                                return { type: 'Download', remote_path: s.payload.remote_path }
                            } else if (s.type === 'UploadDir') {
                                return { type: 'UploadDir', local_path: s.payload.local_path, remote_path: s.payload.remote_path }
                            } else if (s.type === 'DownloadDir') {
                                return { type: 'DownloadDir', remote_path: s.payload.remote_path }
                            }
                            return s
                        })
                        
                        newScript.value = { name: rawScript.name, steps }
                    } else {
                        isCreatingScript.value = true
                        selectedScript.value = null
                        newScript.value = { name: '', steps: [] }
                    }
                }

                const addStep = () => {
                    newScript.value.steps.push({ type: 'Shell', cmd: '', args: '', local_path: '', remote_path: '' })
                }

                const removeStep = (index) => {
                    newScript.value.steps.splice(index, 1)
                }

                const saveScript = async () => {
                    if (!newScript.value.name) return alert('Name required')
                    
                    const steps = newScript.value.steps.map(s => {
                        if (s.type === 'Shell') {
                            return { type: 'Shell', payload: { cmd: s.cmd, args: s.args.split(' ').filter(a => a) } }
                        } else if (s.type === 'Upload') {
                            return { type: 'Upload', payload: { local_path: s.local_path, remote_path: s.remote_path } }
                        } else if (s.type === 'Download') {
                            return { type: 'Download', payload: { remote_path: s.remote_path } }
                        } else if (s.type === 'UploadDir') {
                            return { type: 'UploadDir', payload: { local_path: s.local_path, remote_path: s.remote_path } }
                        } else if (s.type === 'DownloadDir') {
                            return { type: 'DownloadDir', payload: { remote_path: s.remote_path } }
                        }
                        return null
                    }).filter(s => s)

                    const payload = { name: newScript.value.name, steps }
                    
                    try {
                        let res;
                        if (isCreatingScript.value) {
                             res = await fetch('/api/scripts', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            })
                        } else {
                             res = await fetch(`/api/scripts/${selectedScript.value.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            })
                        }
                        
                        if (res.ok) {
                            await fetchScripts()
                            closeModal()
                        } else {
                            alert('Failed to save script')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }
                
                const deleteScript = async (id) => {
                    if (!confirm('Are you sure you want to delete this script?')) return;
                    try {
                        const res = await fetch(`/api/scripts/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            await fetchScripts();
                        } else {
                            alert('Failed to delete script');
                        }
                    } catch (e) {
                        alert(e.message);
                    }
                }

                const openRunScript = (script) => {
                    selectedScript.value = script
                    selectedClientIds.value = []
                    activeModal.value = 'runScript'
                }

                const executeScript = async () => {
                    if (!selectedScript.value || selectedClientIds.value.length === 0) return
                    
                    try {
                        const res = await fetch(`/api/scripts/${selectedScript.value.id}/run`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ client_ids: selectedClientIds.value })
                        })
                        
                        if (res.ok) {
                            alert(t('scriptStarted'))
                            closeModal()
                            currentView.value = 'history'
                            fetchHistory()
                        } else {
                            const err = await res.text()
                            alert('Failed to start script: ' + err)
                        }
                    } catch (e) {
                        alert('Error: ' + e.message)
                    }
                }

                const fetchHistory = async () => {
                    try {
                        const res = await fetch('/api/history')
                        if (res.ok) {
                            historyList.value = await res.json()
                        }
                    } catch (e) {
                        console.error('Failed to fetch history', e)
                    }
                }

                const clearHistory = async () => {
                    if (!confirm(t('clearLogs') + '?')) return
                    try {
                        const res = await fetch('/api/history', { method: 'DELETE' })
                        if (res.ok) {
                            alert(t('logsCleared'))
                            fetchHistory()
                        } else {
                            alert('Failed to clear logs')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }
                
                const viewLogs = (item) => {
                    selectedLogs.value = item.logs
                    activeModal.value = 'logs'
                    isMaximized.value = false
                }

                const navigateUp = () => {
                     const parts = currentPath.value.split(/[/\\]/);
                     parts.pop();
                     const newPath = parts.join('/') || '.';
                     listFiles(newPath);
                }
                
                const fetchUpdates = async () => {
                    try {
                        const res = await fetch('/api/updates')
                        if (res.ok) {
                            updateList.value = await res.json()
                        }
                    } catch (e) {
                        console.error(e)
                    }
                }

                const openUploadUpdateModal = () => {
                    activeModal.value = 'uploadUpdate'
                    newUpdate.value = { version: '', platform: 'windows' }
                    if (updateFileInput.value) updateFileInput.value.value = ''
                }

                const uploadUpdate = async () => {
                    if (!newUpdate.value.version || !updateFileInput.value?.files[0]) {
                        return alert('Please fill all fields')
                    }
                    
                    const formData = new FormData()
                    formData.append('version', newUpdate.value.version)
                    formData.append('platform', newUpdate.value.platform)
                    formData.append('file', updateFileInput.value.files[0])
                    
                    commandLoading.value = true
                    try {
                        const res = await fetch('/api/updates', {
                            method: 'POST',
                            body: formData
                        })
                        
                        if (res.ok) {
                            alert('Update uploaded successfully')
                            closeModal()
                            fetchUpdates()
                        } else {
                            const txt = await res.text()
                            alert('Upload failed: ' + txt)
                        }
                    } catch (e) {
                        alert(e.message)
                    } finally {
                        commandLoading.value = false
                    }
                }

                const deleteUpdate = async (id) => {
                    if (!confirm('Are you sure you want to delete this update?')) return
                    try {
                        const res = await fetch(`/api/updates/${id}`, { method: 'DELETE' })
                        if (res.ok) {
                            fetchUpdates()
                        } else {
                            alert('Failed to delete update')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const openDeployUpdate = (upd) => {
                    selectedUpdate.value = upd
                    selectedClientIds.value = []
                    activeModal.value = 'deployUpdate'
                }

                const triggerDeploy = async () => {
                    if (!selectedUpdate.value || selectedClientIds.value.length === 0) return
                    
                    try {
                        const res = await fetch('/api/updates/trigger', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                update_id: selectedUpdate.value.id,
                                client_ids: selectedClientIds.value
                            })
                        })
                        
                        if (res.ok) {
                            const msg = await res.text()
                            alert(msg)
                            closeModal()
                        } else {
                            const txt = await res.text()
                            alert('Failed to trigger update: ' + txt)
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const joinPath = (base, part) => {
                    if (base.endsWith('/') || base.endsWith('\\')) return base + part;
                    return base === '.' ? part : `${base}/${part}`;
                }

                const closeModal = () => {
                    activeModal.value = null
                    selectedClient.value = null
                }

                const formatBytes = (bytes, decimals = 2) => {
                    if (!+bytes) return '0 Bytes'
                    const k = 1024
                    const dm = decimals < 0 ? 0 : decimals
                    const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB']
                    const i = Math.floor(Math.log(bytes) / Math.log(k))
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`
                }

                return {
                    clients, serverInfo, activeModal, selectedClient, commandLoading,
                    searchQuery, statusFilter, filteredClients,
                    hardwareInfo, shellInput, shellOutput, shellFileInput, shellOutputRef,
                    currentPath, fileList, fileInput,
                    openHardware, openShell, runShellCommand, triggerShellUpload, handleShellUpload,
                    openFiles, listFiles, 
                    triggerFileUpload, handleFileUpload, downloadFromClient,
                    openEditor, closeEditor, saveFile, editorFile, editorContent,
                    openScripts, scriptList, selectedScript, isCreatingScript, newScript, scriptStatus,
                    openScriptEditor, saveScript, addStep, removeStep, deleteScript, openRunScript, executeScript,
                    fetchGroups, groupList, selectedGroup, isCreatingGroup, newGroup, openGroupEditor, saveGroup, deleteGroup, runGroupScripts,
                    fetchHistory, historyList, viewLogs, selectedLogs, clearHistory,
                    executionList, viewingExecutionId, viewingExecution,
                    selectedClientIds, currentView, fetchScripts,
                    updateList, selectedUpdate, newUpdate, updateFileInput, fetchUpdates, openUploadUpdateModal, uploadUpdate, deleteUpdate, openDeployUpdate, triggerDeploy,
                    closeModal, formatBytes, navigateUp, joinPath,
                    isMaximized, toggleMaximize,
                    t, toggleLang, lang
                }
            }
        }).mount('#app')
    </script>
</body>
</html>

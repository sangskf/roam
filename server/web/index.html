<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roam - Remote Maintenance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- File Preview Libraries -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        .docx-wrapper {
            background: #fff;
            padding: 20px;
        }
        .xlsx-preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .xlsx-preview th, .xlsx-preview td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        .xlsx-preview th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .xlsx-preview tr:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="app" class="min-h-screen p-2 md:p-6 flex flex-col">
        <header class="mb-4 md:mb-6 bg-white shadow-sm sticky top-0 z-40">
            <div class="px-4">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <div class="flex items-center gap-2">
                         <h1 class="text-xl md:text-2xl font-bold text-blue-600 truncate">{{ t('dashboardTitle') }} <span v-if="serverInfo" class="text-xs text-gray-400 font-normal">v{{ serverInfo.version }}</span></h1>
                    </div>
        
                    <!-- Desktop Nav -->
                    <nav class="hidden md:flex space-x-1">
                         <button @click="currentView = 'dashboard'" :class="['px-3 py-2 rounded-md text-sm font-medium transition', currentView === 'dashboard' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100']">{{ t('dashboard') }}</button>
                         <button @click="currentView = 'groups'; fetchGroups()" :class="['px-3 py-2 rounded-md text-sm font-medium transition', currentView === 'groups' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100']">{{ t('groups') }}</button>
                         <button @click="currentView = 'scripts'; fetchScripts()" :class="['px-3 py-2 rounded-md text-sm font-medium transition', currentView === 'scripts' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100']">{{ t('scripts') }}</button>
                         <button @click="currentView = 'history'; fetchHistory()" :class="['px-3 py-2 rounded-md text-sm font-medium transition', currentView === 'history' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100']">{{ t('history') }}</button>
                         <button @click="currentView = 'updates'; fetchUpdates()" :class="['px-3 py-2 rounded-md text-sm font-medium transition', currentView === 'updates' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100']">{{ t('updates') }}</button>
                    </nav>
        
                    <!-- Desktop Right Side -->
                    <div class="hidden md:flex items-center gap-4">
                        <span class="text-sm text-gray-500 whitespace-nowrap">{{ t('connectedClients') }}: {{ clients.length }}</span>
                        
                        <!-- Auth Menu -->
                        <div v-if="authEnabled && isLoggedIn" class="relative group">
                            <button class="flex items-center gap-1 text-sm font-medium hover:text-blue-600 focus:outline-none py-2">
                                <span>{{ username }}</span>
                                <span class="text-xs">‚ñº</span>
                            </button>
                            <div class="absolute right-0 top-full pt-1 w-48 hidden group-hover:block z-50">
                                <div class="bg-white rounded-md shadow-lg py-1 border">
                                    <button @click="showPasswordModal = true" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">{{ t('changePassword') }}</button>
                                    <button @click="logout" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">{{ t('logout') }}</button>
                                </div>
                            </div>
                        </div>

                        <button @click="toggleLang" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-xs font-medium transition">
                            {{ t('switchLang') }}
                        </button>
                    </div>
        
                    <!-- Mobile Menu Button -->
                    <div class="md:hidden flex items-center">
                        <button @click="toggleMenu" class="text-gray-600 hover:text-gray-900 focus:outline-none p-2">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path v-if="!isMenuOpen" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                <path v-else stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        
            <!-- Mobile Menu -->
            <div v-show="isMenuOpen" class="md:hidden border-t border-gray-100 bg-white absolute w-full shadow-lg">
                <div class="px-2 pt-2 pb-3 space-y-1">
                     <button @click="currentView = 'dashboard'; isMenuOpen = false" :class="['block w-full text-left px-3 py-2 rounded-md text-base font-medium', currentView === 'dashboard' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50']">{{ t('dashboard') }}</button>
                     <button @click="currentView = 'groups'; fetchGroups(); isMenuOpen = false" :class="['block w-full text-left px-3 py-2 rounded-md text-base font-medium', currentView === 'groups' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50']">{{ t('groups') }}</button>
                     <button @click="currentView = 'scripts'; fetchScripts(); isMenuOpen = false" :class="['block w-full text-left px-3 py-2 rounded-md text-base font-medium', currentView === 'scripts' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50']">{{ t('scripts') }}</button>
                     <button @click="currentView = 'history'; fetchHistory(); isMenuOpen = false" :class="['block w-full text-left px-3 py-2 rounded-md text-base font-medium', currentView === 'history' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50']">{{ t('history') }}</button>
                     <button @click="currentView = 'updates'; fetchUpdates(); isMenuOpen = false" :class="['block w-full text-left px-3 py-2 rounded-md text-base font-medium', currentView === 'updates' ? 'bg-blue-50 text-blue-700' : 'text-gray-600 hover:bg-gray-50']">{{ t('updates') }}</button>
                </div>
                <div class="pt-4 pb-4 border-t border-gray-100 px-4">
                    <div v-if="authEnabled && isLoggedIn" class="mb-3 border-b pb-3">
                         <div class="font-bold text-gray-800 mb-2">{{ username }}</div>
                         <button @click="showPasswordModal = true; isMenuOpen = false" class="block w-full text-left py-1 text-sm text-gray-600">{{ t('changePassword') }}</button>
                         <button @click="logout" class="block w-full text-left py-1 text-sm text-red-600">{{ t('logout') }}</button>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500">{{ t('connectedClients') }}: {{ clients.length }}</span>
                        <button @click="toggleLang" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-xs font-medium">
                            {{ t('switchLang') }}
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard View -->
        <div v-if="currentView === 'dashboard'" class="bg-white rounded-lg shadow-md overflow-hidden flex-1 flex flex-col">
            <div class="p-4 border-b bg-gray-50 flex flex-col md:flex-row gap-4 items-center">
                <div class="relative flex-1 w-full md:w-auto max-w-full md:max-w-md">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">üîç</span>
                    <input v-model="searchQuery" type="text" :placeholder="t('searchPlaceholder')" class="w-full border rounded pl-10 pr-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <select v-model="statusFilter" class="w-full md:w-auto border rounded px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value="all">{{ t('allStatus') }}</option>
                    <option value="online">{{ t('online') }}</option>
                    <option value="offline">{{ t('offline') }}</option>
                </select>
            </div>
            <div class="flex-1 overflow-auto">
                <div class="md:hidden">
                    <!-- Mobile Card View -->
                    <div v-for="client in filteredClients" :key="client.id" class="p-4 border-b last:border-b-0">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-lg">{{ client.hostname }}</div>
                                <div class="text-sm text-gray-500">{{ client.alias || '-' }}</div>
                            </div>
                            <span :class="{'px-2 py-1 rounded text-xs font-bold': true, 
                                'bg-green-100 text-green-700': client.status === 'online',
                                'bg-gray-100 text-gray-500': client.status === 'offline'
                            }">{{ t(client.status) }}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                            <div>{{ client.ip }}</div>
                            <div>{{ client.os }}</div>
                            <div class="text-xs font-mono">{{ client.version }}</div>
                            <div class="text-xs text-gray-500 text-right">{{ formatDate(client.last_seen) }}</div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="openHardware(client)" :disabled="client.status === 'offline'" :class="['flex-1 py-2 rounded border text-center text-sm', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-green-600 hover:bg-green-100 border-green-200']">{{ t('hardware') }}</button>
                            <button @click="openShell(client)" :disabled="client.status === 'offline'" :class="['flex-1 py-2 rounded border text-center text-sm', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100 border-gray-300']">{{ t('shell') }}</button>
                            <button @click="openFiles(client)" :disabled="client.status === 'offline'" :class="['flex-1 py-2 rounded border text-center text-sm', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-100 border-blue-200']">{{ t('files') }}</button>
                            <button @click="deleteClient(client)" class="flex-1 py-2 rounded border text-center text-sm text-red-600 hover:bg-red-100 border-red-200">{{ t('delete') }}</button>
                        </div>
                    </div>
                    <div v-if="filteredClients.length === 0" class="p-8 text-center text-gray-400 italic">
                        {{ t('noClients') }}
                    </div>
                </div>
                <table class="hidden md:table w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-gray-50 z-10 shadow-sm">
                        <tr class="text-gray-700 text-sm">
                            <th class="p-4 border-b">{{ t('hostname') }}</th>
                            <th class="p-4 border-b">{{ t('alias') }}</th>
                            <th class="p-4 border-b">{{ t('ipAddress') }}</th>
                            <th class="p-4 border-b">{{ t('os') }}</th>
                            <th class="p-4 border-b">{{ t('version') }}</th>
                            <th class="p-4 border-b">{{ t('status') }}</th>
                            <th class="p-4 border-b">{{ t('lastSeen') }}</th>
                            <th class="p-4 border-b">{{ t('actions') }}</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        <tr v-for="client in filteredClients" :key="client.id" class="hover:bg-blue-50 border-b last:border-b-0 transition-colors">
                        <td class="p-4">{{ client.hostname }}</td>
                        <td class="p-4 font-medium">{{ client.alias || '-' }}</td>
                        <td class="p-4 font-mono text-gray-500">{{ client.ip }}</td>
                        <td class="p-4">{{ client.os }}</td>
                        <td class="p-4 font-mono text-gray-500">{{ client.version }}</td>
                        <td class="p-4">
                            <span :class="{'px-2 py-1 rounded text-xs font-bold': true, 
                                'bg-green-100 text-green-700': client.status === 'online',
                                'bg-gray-100 text-gray-500': client.status === 'offline'
                            }">{{ t(client.status) }}</span>
                        </td>
                        <td class="p-4 text-xs text-gray-500">{{ formatDate(client.last_seen) }}</td>
                        <td class="p-4 flex gap-2">
                            <button @click="openHardware(client)" :disabled="client.status === 'offline'" :class="['px-2 py-1 rounded border whitespace-nowrap', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-green-600 hover:bg-green-100 border-green-200']">{{ t('hardware') }}</button>
                            <button @click="openShell(client)" :disabled="client.status === 'offline'" :class="['px-2 py-1 rounded border whitespace-nowrap', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-gray-700 hover:bg-gray-100 border-gray-300']">{{ t('shell') }}</button>
                            <button @click="openFiles(client)" :disabled="client.status === 'offline'" :class="['px-2 py-1 rounded border whitespace-nowrap', client.status === 'offline' ? 'text-gray-400 border-gray-200 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-100 border-blue-200']">{{ t('files') }}</button>
                            <button @click="deleteClient(client)" class="px-2 py-1 rounded border whitespace-nowrap text-red-600 hover:bg-red-100 border-red-200">{{ t('delete') }}</button>
                        </td>
                    </tr>
                    <tr v-if="filteredClients.length === 0">
                        <td colspan="8" class="p-12 text-center text-gray-400 italic">{{ t('noClients') }}</td>
                    </tr>
                </tbody>
            </table>
            </div>
        </div>

        <!-- Groups View -->
        <div v-if="currentView === 'groups'" class="bg-white rounded-lg shadow-md p-6 flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">{{ t('groupManager') }}</h2>
                <button @click="openGroupEditor()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2">
                    <span>+</span> {{ t('createGroup') }}
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="group in groupList" :key="group.id" class="border rounded-lg p-4 hover:shadow-md transition bg-gray-50 flex flex-col">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">{{ group.name }}</h3>
                        <div class="flex gap-1">
                            <button @click="openGroupEditor(group)" class="text-gray-500 hover:text-blue-600 p-1" title="Edit">‚úé</button>
                            <button @click="deleteGroup(group.id)" class="text-gray-500 hover:text-red-600 p-1" title="Delete">üóë</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 mb-4 flex-1">
                        {{ group.client_ids.length }} {{ t('clients') }}
                        <span v-if="group.script_ids && group.script_ids.length > 0" class="ml-2 text-blue-600">
                             ‚Ä¢ {{ group.script_ids.length }} {{ t('boundScripts') }}
                        </span>
                    </div>
                    <div class="mt-2 pt-2 border-t flex justify-end">
                         <button @click="runGroupScripts(group)" class="text-sm bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 shadow-sm flex items-center gap-1">
                            <span>‚ñ∂</span> {{ t('runBoundScripts') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scripts View -->
        <div v-if="currentView === 'scripts'" class="bg-white rounded-lg shadow-md p-6 flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">{{ t('scriptManager') }}</h2>
                <button @click="openScriptEditor()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2">
                    <span>+</span> {{ t('createScript') }}
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="script in scriptList" :key="script.id" class="border rounded-lg p-4 hover:shadow-md transition bg-gray-50 flex flex-col">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-gray-800">{{ script.name }}</h3>
                        <div class="flex gap-1">
                            <button @click="openScriptEditor(script)" class="text-gray-500 hover:text-blue-600 p-1" title="Edit">‚úé</button>
                            <button @click="deleteScript(script.id)" class="text-gray-500 hover:text-red-600 p-1" title="Delete">üóë</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 mb-4 flex-1">
                        {{ script.steps.length }} {{ t('steps') }}
                    </div>
                    <button @click="openRunScript(script)" class="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 py-2 rounded font-medium transition">
                        {{ t('runScript') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Updates View -->
        <div v-if="currentView === 'updates'" class="bg-white rounded-lg shadow-md p-6 flex-1 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">{{ t('updateManager') }}</h2>
                <button @click="openUploadUpdateModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2">
                    <span>+</span> {{ t('uploadUpdate') }}
                </button>
            </div>
            
            <div class="overflow-auto">
                 <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-700 text-sm">
                            <th class="p-4 border-b">{{ t('version') }}</th>
                            <th class="p-4 border-b">{{ t('platform') }}</th>
                            <th class="p-4 border-b">{{ t('filename') }}</th>
                            <th class="p-4 border-b">{{ t('uploadedAt') }}</th>
                            <th class="p-4 border-b">{{ t('actions') }}</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        <tr v-for="upd in updateList" :key="upd.id" class="hover:bg-blue-50 border-b last:border-b-0 transition-colors">
                            <td class="p-4 font-medium">{{ upd.version }}</td>
                            <td class="p-4">
                                <span :class="{'px-2 py-1 rounded text-xs font-bold': true, 
                                    'bg-blue-100 text-blue-700': upd.platform === 'windows',
                                    'bg-orange-100 text-orange-700': upd.platform === 'linux',
                                    'bg-gray-100 text-gray-700': upd.platform === 'macos'
                                }">{{ upd.platform }}</span>
                            </td>
                            <td class="p-4 font-mono text-gray-500">{{ upd.filename }}</td>
                            <td class="p-4 text-gray-500">{{ new Date(upd.uploaded_at).toLocaleString() }}</td>
                            <td class="p-4 flex gap-2">
                                <button @click="openDeployUpdate(upd)" class="text-green-600 hover:bg-green-100 px-2 py-1 rounded border border-green-200">{{ t('deploy') }}</button>
                                <button @click="deleteUpdate(upd.id)" class="text-red-600 hover:bg-red-100 px-2 py-1 rounded border border-red-200">{{ t('delete') }}</button>
                            </td>
                        </tr>
                        <tr v-if="updateList.length === 0">
                            <td colspan="5" class="p-12 text-center text-gray-400 italic">{{ t('noUpdates') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- History View -->
        <div v-if="currentView === 'history'" class="bg-white rounded-lg shadow-md overflow-hidden flex-1">
             <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-lg">{{ t('executionHistory') }}</h2>
                <div class="flex gap-2">
                    <button @click="clearHistory" class="text-red-600 text-sm hover:underline">{{ t('clearLogs') }}</button>
                    <button @click="fetchHistory" class="text-blue-600 text-sm hover:underline">{{ t('refresh') }}</button>
                </div>
            </div>
            <table class="w-full text-left border-collapse text-sm">
                <thead>
                    <tr class="bg-gray-50 text-gray-700">
                        <th class="p-3 border-b">{{ t('time') }}</th>
                        <th class="p-3 border-b">{{ t('scriptName') }}</th>
                        <th class="p-3 border-b">{{ t('client') }}</th>
                        <th class="p-3 border-b">{{ t('status') }}</th>
                        <th class="p-3 border-b">{{ t('logs') }}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in historyList" :key="item.id" class="border-b hover:bg-gray-50">
                        <td class="p-3 font-mono text-xs text-gray-500">{{ new Date(item.started_at).toLocaleString() }}</td>
                        <td class="p-3 font-medium">{{ item.script_name }}</td>
                        <td class="p-3">{{ item.client_hostname }}</td>
                        <td class="p-3">
                            <span :class="{'px-2 py-0.5 rounded-full text-xs font-bold': true, 
                                'bg-green-100 text-green-700': item.status === 'completed',
                                'bg-red-100 text-red-700': item.status === 'failed',
                                'bg-blue-100 text-blue-700': item.status === 'running'
                            }">{{ item.status }}</span>
                        </td>
                        <td class="p-3">
                            <button @click="viewLogs(item)" class="text-blue-600 hover:underline text-xs">{{ t('viewLogs') }}</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Modals -->
        
        <!-- Hardware Info Modal -->
        <div v-if="activeModal === 'hardware'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg w-full md:max-w-md m-4 md:m-0 p-6">
                <h3 class="text-xl font-bold mb-4">{{ t('hardwareInfo') }}: {{ selectedClient?.hostname }}</h3>
                <div v-if="commandLoading" class="text-center py-4">{{ t('loading') }}</div>
                <div v-else-if="hardwareInfo" class="space-y-3">
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">{{ t('platform') }}</span>
                        <span class="font-medium">{{ hardwareInfo.platform }}</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">{{ t('cpuUsage') }}</span>
                        <span class="font-medium">{{ hardwareInfo.cpu_usage.toFixed(2) }}%</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">{{ t('totalMemory') }}</span>
                        <span class="font-medium">{{ formatBytes(hardwareInfo.total_memory) }}</span>
                    </div>
                    <div class="flex justify-between pb-2">
                        <span class="text-gray-600">{{ t('usedMemory') }}</span>
                        <span class="font-medium">{{ formatBytes(hardwareInfo.used_memory) }}</span>
                    </div>
                </div>
                <div v-else class="text-red-500">{{ t('failedInfo') }}</div>
                <div class="mt-6 flex justify-end">
                    <button @click="closeModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('close') }}</button>
                </div>
            </div>
        </div>

        <!-- Shell Modal -->
        <div v-if="activeModal === 'shell'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full md:w-3/4 lg:w-1/2 h-[80vh] md:h-[600px]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg">{{ t('remoteShell') }}: {{ selectedClient?.hostname }}</h3>
                    <div class="flex items-center gap-2">
                         <div class="flex items-center bg-white border rounded shadow-sm">
                             <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                                <span v-if="isMaximized">‚ùê</span>
                                <span v-else>‚òê</span>
                            </button>
                            <button @click="closeModal" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                                ‚úï
                            </button>
                         </div>
                    </div>
                </div>
                <div ref="shellOutputRef" class="flex-1 bg-gray-900 text-green-400 p-4 mx-4 mt-4 mb-4 rounded font-mono text-sm overflow-auto whitespace-pre-wrap">{{ shellOutput }}</div>
                <form @submit.prevent="runShellCommand" class="flex gap-2 mx-4 mb-4">
                    <input v-model="shellInput" type="text" :placeholder="t('enterCommand')" class="flex-1 border rounded px-3 py-2 font-mono" autofocus>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">{{ t('run') }}</button>
                    <button type="button" @click="triggerShellUpload" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center gap-1" :title="t('upload')">
                        {{ t('upload') }}
                    </button>
                </form>
                <!-- Hidden file input for shell upload -->
                <input type="file" ref="shellFileInput" class="hidden" @change="handleShellUpload">
            </div>
        </div>

        <!-- Preview Modal -->
        <div v-if="activeModal === 'preview'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full md:w-3/4 lg:w-1/2 h-[80vh] md:h-[600px]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg">{{ t('preview') }}: {{ previewFile?.name }}</h3>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                         <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                            <span v-if="isMaximized">‚ùê</span>
                            <span v-else>‚òê</span>
                        </button>
                        <button @click="closePreview" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-auto bg-gray-100 flex flex-col p-4 relative">
                     <div v-if="previewLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100 z-10">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-4"></div>
                        <span class="text-gray-500">{{ t('loading') }}</span>
                     </div>
                     
                     <div v-else-if="previewType === 'image'" class="flex items-center justify-center h-full">
                        <img :src="previewUrl" class="max-w-full max-h-full object-contain shadow-lg">
                     </div>
                     <div v-else-if="previewType === 'video'" class="flex items-center justify-center h-full">
                        <video :src="previewUrl" controls class="max-w-full max-h-full shadow-lg"></video>
                     </div>
                     <div v-else-if="previewType === 'audio'" class="flex items-center justify-center h-full">
                        <audio :src="previewUrl" controls class="w-full max-w-md shadow-lg"></audio>
                     </div>
                     <div v-else-if="previewType === 'pdf'" class="h-full w-full">
                        <iframe :src="previewUrl" class="w-full h-full shadow-lg border-0 bg-white"></iframe>
                     </div>
                     <div v-else-if="previewType === 'docx'" class="w-full min-h-full bg-white shadow-lg p-8 overflow-auto flex justify-center">
                        <div ref="docxContainer" class="docx-wrapper w-full max-w-4xl"></div>
                     </div>
                     <div v-else-if="previewType === 'xlsx'" class="w-full h-full bg-white shadow-lg overflow-auto p-4 xlsx-preview">
                        <div v-html="previewContent" class="prose max-w-none"></div>
                    </div>
                     <div v-else-if="previewType === 'zip'" class="w-full h-full bg-white shadow-lg flex flex-col overflow-hidden rounded">
                        <div class="bg-gray-50 p-3 border-b font-bold flex justify-between shrink-0">
                            <span>{{ t('archiveContents') }}</span>
                            <span class="text-sm font-normal text-gray-500">{{ previewItems.length }} {{ t('items') }}</span>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 border-b sticky top-0">
                                    <tr>
                                        <th class="p-2 text-left">{{ t('name') }}</th>
                                        <th class="p-2 text-right">{{ t('size') }}</th>
                                        <th class="p-2 text-right">{{ t('date') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in previewItems" :key="item.name" class="border-b hover:bg-gray-50">
                                        <td class="p-2 flex items-center gap-2">
                                            <span v-if="item.dir" class="text-yellow-500">üìÅ</span>
                                            <span v-else class="text-gray-400">üìÑ</span>
                                            {{ item.name }}
                                        </td>
                                        <td class="p-2 text-right font-mono">{{ item.dir ? '-' : formatBytes(item.size) }}</td>
                                        <td class="p-2 text-right text-gray-500">{{ new Date(item.date).toLocaleString() }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                     </div>
                     <div v-else class="flex items-center justify-center h-full text-red-500">
                        {{ t('previewError') || 'Unsupported file type' }}
                     </div>
                </div>
                
                <div class="p-4 border-t flex justify-end gap-2 bg-gray-50">
                    <button @click="downloadFromClient(previewFile)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-sm flex items-center gap-2">
                        <span>‚¨á</span> {{ t('download') }}
                    </button>
                    <button @click="closePreview" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('close') }}</button>
                </div>
            </div>
        </div>

        <!-- Files Modal -->
        <div v-if="activeModal === 'files'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full md:w-3/4 lg:w-1/2 h-[80vh] md:h-[600px]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg">{{ t('fileBrowser') }}: {{ selectedClient?.hostname }}</h3>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                         <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                            <span v-if="isMaximized">‚ùê</span>
                            <span v-else>‚òê</span>
                        </button>
                        <button @click="closeModal" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-2 my-4 mx-4">
                    <input v-model="currentPath" @keyup.enter="listFiles(currentPath)" class="flex-1 border rounded px-2 py-1 text-sm font-mono bg-gray-50">
                    <button @click="listFiles(currentPath)" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Go</button>
                    <button @click="navigateUp" class="bg-gray-300 px-3 py-1 rounded text-sm">Up</button>
                    <button @click="triggerFileUpload" class="bg-green-500 text-white px-3 py-1 rounded text-sm ml-auto">{{ t('uploadToClient') }}</button>
                    <input type="file" ref="fileInput" class="hidden" @change="handleFileUpload">
                </div>
                
                <div class="flex-1 overflow-auto border rounded mx-4 mb-4">
                     <div v-if="commandLoading" class="p-4 text-center text-gray-500">{{ t('loading') }}</div>
                     <table v-else class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">{{ t('name') }}</th>
                                <th class="p-2 text-right">{{ t('size') }}</th>
                                <th class="p-2 text-center">{{ t('type') }}</th>
                                <th class="p-2 text-right">{{ t('action') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="file in fileList" :key="file.name" class="hover:bg-blue-50 cursor-pointer border-b" @click="file.is_dir ? listFiles(joinPath(currentPath, file.name)) : null">
                                <td class="p-2 flex items-center gap-2">
                                    <span v-if="file.is_dir" class="text-yellow-500">üìÅ</span>
                                    <span v-else class="text-gray-400">üìÑ</span>
                                    {{ file.name }}
                                </td>
                                <td class="p-2 text-right font-mono">{{ file.is_dir ? '-' : formatBytes(file.size) }}</td>
                                <td class="p-2 text-center text-xs text-gray-500">{{ file.is_dir ? 'DIR' : 'FILE' }}</td>
                                <td class="p-2 text-right">
                                    <button v-if="!file.is_dir" @click.stop="downloadFromClient(file)" class="text-blue-500 hover:underline text-xs bg-white border px-2 py-0.5 rounded shadow-sm mr-2">{{ t('download') }}</button>
                                    <button v-if="!file.is_dir" @click.stop="openFileHandler(file)" class="text-gray-700 hover:underline text-xs bg-white border px-2 py-0.5 rounded shadow-sm">{{ t('preview') }}</button>
                                </td>
                            </tr>
                        </tbody>
                     </table>
                </div>
            </div>
        </div>

        <!-- Editor Modal -->
        <div v-if="activeModal === 'editor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full md:w-3/4 lg:w-1/2 h-[80vh] md:h-[600px]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold text-lg">{{ t('viewingEditing') }}: {{ editorFile?.name }}</h3>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                         <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                            <span v-if="isMaximized">‚ùê</span>
                            <span v-else>‚òê</span>
                        </button>
                        <button @click="closeEditor" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div v-if="commandLoading" class="flex-1 flex items-center justify-center">{{ t('loading') }}</div>
                <textarea v-else v-model="editorContent" class="flex-1 border rounded p-4 mx-4 my-4 font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                
                <div class="p-4 pt-0 flex justify-end gap-2 mb-2">
                    <button @click="closeEditor" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('closeCancel') }}</button>
                    <button @click="saveFile" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" :disabled="commandLoading">{{ t('saveChanges') }}</button>
                </div>
            </div>
        </div>

        <!-- Group Editor Modal -->
        <div v-if="activeModal === 'groupEditor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full md:max-w-md m-4 md:m-0 flex flex-col max-h-[90vh]">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ isCreatingGroup ? t('createGroup') : t('editGroup') }}</h3>
                </div>
                <div class="p-6 max-h-[60vh] overflow-auto">
                    <div class="mb-4" v-if="isCreatingGroup">
                        <label class="block text-sm font-bold mb-1">{{ t('groupName') }}</label>
                        <input v-model="newGroup.name" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div v-else>
                        <h4 class="font-bold mb-2">{{ selectedGroup?.name }}</h4>
                    </div>
                    
                    <p class="mb-2 text-sm text-gray-600 font-bold">{{ t('selectClients') }}</p>
                    <div class="space-y-2">
                        <label v-for="client in clients" :key="client.id" class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer border">
                            <input type="checkbox" :value="client.id" v-model="newGroup.client_ids" class="mr-3 h-4 w-4 text-blue-600">
                            <div>
                                <div class="font-medium text-sm">
                                    {{ client.hostname }}
                                    <span v-if="client.alias" class="text-gray-500 font-normal ml-1">({{ client.alias }})</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ client.ip }}</div>
                            </div>
                        </label>
                        <div v-if="clients.length === 0" class="text-center text-gray-400 py-4">{{ t('noClients') }}</div>
                    </div>
                    
                    <div class="mt-4 mb-2">
                        <p class="mb-2 text-sm text-gray-600 font-bold">{{ t('bindScripts') }}</p>
                        <div class="space-y-2 max-h-40 overflow-auto border p-2 rounded bg-gray-50">
                            <label v-for="script in scriptList" :key="script.id" class="flex items-center p-2 hover:bg-white rounded cursor-pointer border border-transparent hover:border-gray-200">
                                <input type="checkbox" :value="script.id" v-model="newGroup.script_ids" class="mr-3 h-4 w-4 text-blue-600">
                                <div class="text-sm font-medium">{{ script.name }}</div>
                            </label>
                            <div v-if="scriptList.length === 0" class="text-center text-gray-400 py-2">{{ t('noScripts') }}</div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="saveGroup" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm">{{ t('save') }}</button>
                </div>
            </div>
        </div>

        <!-- Script Editor Modal -->
        <div v-if="activeModal === 'scriptEditor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl m-4 md:m-0 flex flex-col max-h-[90vh]">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ isCreatingScript ? t('createScript') : t('editScript') }}</h3>
                </div>
                <div class="p-6 overflow-auto flex-1">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1">{{ t('scriptName') }}</label>
                        <input v-model="newScript.name" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-bold">{{ t('steps') }}</label>
                            <button @click="addStep" class="text-sm text-blue-600 hover:underline">+ {{ t('addStep') }}</button>
                        </div>
                        
                        <div class="space-y-3">
                            <div v-for="(step, index) in newScript.steps" :key="index" class="border rounded p-3 bg-gray-50 relative group">
                                <button @click="removeStep(index)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">‚úï</button>
                                <div class="flex gap-4 mb-2">
                                    <div class="w-1/4">
                                        <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('stepType') }}</label>
                                        <select v-model="step.type" class="w-full border rounded px-2 py-1 text-sm bg-white">
                                            <option value="Shell">{{ t('shell') }}</option>
                                            <option value="Upload">{{ t('uploadFile') }}</option>
                                            <option value="Download">{{ t('downloadFile') }}</option>
                                            <option value="UploadDir">{{ t('uploadDir') }}</option>
                                            <option value="DownloadDir">{{ t('downloadDir') }}</option>
                                        </select>
                                    </div>
                                    <div class="flex-1">
                                        <div v-if="step.type === 'Shell'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('command') }}</label>
                                            <input v-model="step.cmd" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="e.g. ls">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('args') }}</label>
                                            <input v-model="step.args" class="w-full border rounded px-2 py-1 text-sm" placeholder="e.g. -la /tmp">
                                        </div>
                                        <div v-if="step.type === 'Upload'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('localPath') }}</label>
                                            <input v-model="step.local_path" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="server/uploads/staging/file.txt">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm" placeholder="/tmp/file.txt">
                                        </div>
                                        <div v-if="step.type === 'Download'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="/etc/passwd">
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" v-model="step.browser_download" class="mr-2">
                                                {{ t('browserDownload') }}
                                            </label>
                                        </div>
                                        <div v-if="step.type === 'UploadDir'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('localPath') }}</label>
                                            <input v-model="step.local_path" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="Folder name in staging (e.g. my-app)">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm" placeholder="/opt/my-app">
                                        </div>
                                        <div v-if="step.type === 'DownloadDir'">
                                            <label class="block text-xs font-bold text-gray-500 mb-1">{{ t('remotePath') }}</label>
                                            <input v-model="step.remote_path" class="w-full border rounded px-2 py-1 text-sm mb-2" placeholder="/var/log/app">
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" v-model="step.browser_download" class="mr-2">
                                                {{ t('browserDownload') }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="saveScript" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm">{{ t('saveScript') }}</button>
                </div>
            </div>
        </div>

        <!-- Run Script Modal -->
        <div v-if="activeModal === 'runScript'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full md:max-w-md m-4 md:m-0 flex flex-col max-h-[90vh]">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ t('runScript') }}: {{ selectedScript?.name }}</h3>
                </div>
                <div class="p-6 max-h-[60vh] overflow-auto">
                    <p class="mb-4 text-sm text-gray-600">{{ t('selectClients') }}</p>
                    <div class="space-y-2">
                        <label v-for="client in clients" :key="client.id" class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer border">
                            <input type="checkbox" :value="client.id" v-model="selectedClientIds" class="mr-3 h-4 w-4 text-blue-600">
                            <div>
                                <div class="font-medium text-sm">
                                    {{ client.hostname }}
                                    <span v-if="client.alias" class="text-gray-500 font-normal ml-1">({{ client.alias }})</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ client.ip }}</div>
                            </div>
                        </label>
                        <div v-if="clients.length === 0" class="text-center text-gray-400 py-4">{{ t('noClients') }}</div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="executeScript" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 shadow-sm" :disabled="selectedClientIds.length === 0">
                        {{ t('startExecution') }} ({{ selectedClientIds.length }})
                    </button>
                </div>
            </div>
        </div>

        <!-- Log Viewer Modal -->
        <div v-if="activeModal === 'logs'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl flex flex-col transition-all duration-300" :class="isMaximized ? 'w-full h-full rounded-none' : 'w-full max-w-2xl max-h-[80vh]'">
                <div class="flex justify-between items-center p-4 border-b bg-gray-50 rounded-t-lg">
                    <h3 class="font-bold flex items-center gap-2">
                        {{ t('executionLogs') }}
                        <button @click="downloadLogFile" class="text-blue-600 hover:text-blue-800" title="Download Logs">
                            <span class="text-sm">üì•</span>
                        </button>
                    </h3>
                    <div class="flex items-center bg-white border rounded shadow-sm">
                         <button @click="toggleMaximize" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r" :title="isMaximized ? t('restore') : t('maximize')">
                            <span v-if="isMaximized">‚ùê</span>
                            <span v-else>‚òê</span>
                        </button>
                        <button @click="closeModal" class="px-3 py-1 hover:bg-red-500 hover:text-white text-gray-600" :title="t('close')">
                            ‚úï
                        </button>
                    </div>
                </div>
                <div class="p-4 overflow-auto bg-gray-900 text-green-400 font-mono text-xs flex-1">
                    <div v-for="(log, i) in selectedLogs" :key="i" class="mb-1 whitespace-pre-wrap">
                        {{ log }}
                        <button v-if="log.includes('http://') || log.includes('https://')" @click="downloadArtifact(log)" class="ml-2 text-blue-300 hover:text-white underline text-xs">
                            [{{ t('openLink') }}]
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Monitor Modal -->
        <div v-if="activeModal === 'executionMonitor'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl m-4 md:m-0 flex flex-col max-h-[90vh] relative">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="font-bold text-lg">{{ t('executionMonitor') }}</h3>
                    <button @click="closeModal" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
                <div class="p-4 overflow-auto flex-1 bg-gray-50">
                    <table class="w-full text-left text-sm border-collapse bg-white shadow-sm rounded">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 border-b">{{ t('client') }}</th>
                                <th class="p-3 border-b">{{ t('scriptName') }}</th>
                                <th class="p-3 border-b">{{ t('status') }}</th>
                                <th class="p-3 border-b">{{ t('progress') }}</th>
                                <th class="p-3 border-b">{{ t('latestLog') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="exec in executionList" :key="exec.execution_id" class="border-b">
                                <td class="p-3 font-medium">{{ exec.client_hostname }}</td>
                                <td class="p-3">{{ exec.script_name }}</td>
                                <td class="p-3">
                                    <span :class="{'px-2 py-0.5 rounded-full text-xs font-bold': true, 
                                        'bg-green-100 text-green-700': exec.status === 'completed',
                                        'bg-red-100 text-red-700': exec.status === 'failed',
                                        'bg-blue-100 text-blue-700': exec.status === 'running'
                                    }">{{ exec.status }}</span>
                                </td>
                                <td class="p-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-20 bg-gray-200 rounded-full h-2.5">
                                            <div class="bg-blue-600 h-2.5 rounded-full" :style="{ width: (exec.current_step / exec.total_steps * 100) + '%' }"></div>
                                        </div>
                                        <span class="text-xs text-gray-500">{{ exec.current_step }}/{{ exec.total_steps }}</span>
                                    </div>
                                </td>
                                <td class="p-3 font-mono text-xs text-gray-500 max-w-xs">
                                    <div class="flex justify-between items-center">
                                        <span class="truncate block max-w-[150px]" :title="exec.logs[exec.logs.length-1]">{{ exec.logs[exec.logs.length-1] || '-' }}</span>
                                        <button @click="viewingExecutionId = exec.execution_id" class="text-blue-600 hover:underline ml-2 whitespace-nowrap">{{ t('viewLogs') }}</button>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="executionList.length === 0">
                                <td colspan="5" class="p-8 text-center text-gray-400">{{ t('noActiveExecutions') }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Live Logs Overlay -->
                <div v-if="viewingExecutionId" class="absolute inset-0 bg-white bg-opacity-95 flex flex-col z-10 p-4">
                     <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h4 class="font-bold">{{ t('liveLogs') }}: {{ viewingExecution?.client_hostname }} - {{ viewingExecution?.script_name }}</h4>
                        <button @click="viewingExecutionId = null" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm">{{ t('back') }}</button>
                    </div>
                    <div class="flex-1 overflow-auto bg-gray-900 text-green-400 font-mono text-xs p-4 rounded">
                         <div v-if="viewingExecution">
                            <div v-for="(log, i) in viewingExecution.logs" :key="i" class="mb-1 whitespace-pre-wrap">{{ log }}</div>
                         </div>
                         <div v-else class="text-gray-500">Execution finished or not found.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Update Modal -->
        <div v-if="activeModal === 'uploadUpdate'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg w-full md:max-w-md m-4 md:m-0 p-6">
                <h3 class="text-xl font-bold mb-4">{{ t('uploadUpdatePackage') }}</h3>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('version') }}</label>
                    <input v-model="newUpdate.version" type="text" placeholder="e.g. 1.0.1" class="w-full border rounded px-3 py-2">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('platform') }}</label>
                    <select v-model="newUpdate.platform" class="w-full border rounded px-3 py-2 bg-white">
                        <option value="windows">Windows</option>
                        <option value="linux">Linux</option>
                        <option value="macos">macOS</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('file') }}</label>
                    <input type="file" ref="updateFileInput" class="w-full border rounded px-3 py-2">
                </div>

                <div class="flex justify-end gap-2">
                    <button @click="closeModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('cancel') }}</button>
                    <button @click="uploadUpdate" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" :disabled="commandLoading">
                        {{ commandLoading ? t('uploading') : t('upload') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Deploy Update Modal -->
        <div v-if="activeModal === 'deployUpdate'" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full md:max-w-md m-4 md:m-0 flex flex-col max-h-[90vh]">
                <div class="p-6 border-b">
                    <h3 class="text-xl font-bold">{{ t('deployUpdate') }}: {{ selectedUpdate?.version }}</h3>
                </div>
                <div class="p-6 max-h-[60vh] overflow-auto">
                    <p class="mb-4 text-sm text-gray-600">{{ t('selectClientsToUpdate') }}</p>
                    <div class="space-y-2">
                        <label v-for="client in clients" :key="client.id" class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer border">
                            <input type="checkbox" :value="client.id" v-model="selectedClientIds" class="mr-3 h-4 w-4 text-blue-600">
                            <div>
                                <div class="font-medium text-sm">
                                    {{ client.hostname }}
                                    <span v-if="client.alias" class="text-gray-500 font-normal ml-1">({{ client.alias }})</span>
                                </div>
                                <div class="text-xs text-gray-500">{{ client.ip }} - {{ client.os }} - v{{ client.version }}</div>
                            </div>
                        </label>
                        <div v-if="clients.length === 0" class="text-center text-gray-400 py-4">{{ t('noClients') }}</div>
                    </div>
                </div>
                <div class="p-6 border-t flex justify-end gap-3">
                    <button @click="closeModal" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">{{ t('cancel') }}</button>
                    <button @click="triggerDeploy" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 shadow-sm" :disabled="selectedClientIds.length === 0">
                        {{ t('startUpdate') }} ({{ selectedClientIds.length }})
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div v-if="authEnabled && !isLoggedIn" class="fixed inset-0 bg-gray-100 flex items-center justify-center overflow-hidden" style="z-index: 100;">
            <canvas id="login-canvas" class="absolute inset-0 w-full h-full"></canvas>
            <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm z-10 relative">
                <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Roam Login</h2>
                <form @submit.prevent="login">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('username') }}</label>
                        <input v-model="loginForm.username" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('password') }}</label>
                        <input type="password" v-model="loginForm.password" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 transition">
                        {{ t('login') }}
                    </button>
                </form>
            </div>
        </div>

        <!-- Password Modal -->
        <div v-if="showPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
                <h3 class="text-xl font-bold mb-4">{{ t('changePassword') }}</h3>
                <form @submit.prevent="changePassword">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('oldPassword') }}</label>
                        <input type="password" v-model="passwordForm.old_password" class="w-full border rounded px-3 py-2">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ t('newPassword') }}</label>
                        <input type="password" v-model="passwordForm.new_password" class="w-full border rounded px-3 py-2">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" @click="showPasswordModal = false" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">{{ t('cancel') }}</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">{{ t('save') }}</button>
                    </div>
                </form>
            </div>
        </div>


    </div>

    <script>
        const { createApp, ref, onMounted, watch, nextTick, computed } = Vue

        // Global Error Handler
        window.onerror = function(msg, url, line, col, error) {
            // alert('Error: ' + msg + '\n' + error);
            console.error('Global Error:', msg, error);
        };

        createApp({
            setup() {
                const clients = ref([])
                const serverInfo = ref(null)
                const currentView = ref('dashboard')
                const activeModal = ref(null)
                const selectedClient = ref(null)
                const commandLoading = ref(false)

                // Auth
                const authEnabled = ref(true) // Default to true (secure by default)
                const isLoggedIn = ref(false)
                const username = ref('')
                const loginForm = ref({ username: '', password: '' })
                const passwordForm = ref({ old_password: '', new_password: '' })
                const showPasswordModal = ref(false)

                const checkAuth = async () => {
                    try {
                        const token = localStorage.getItem('auth_token')
                        const headers = token ? { 'Authorization': `Bearer ${token}` } : {}
                        // Add cache busting
                        const res = await fetch('/api/auth/status?t=' + Date.now(), { headers })
                        if (res.ok) {
                            const data = await res.json()
                            console.log('Auth Status:', data)
                            authEnabled.value = data.enabled
                            if (data.enabled) {
                                if (data.username) {
                                    isLoggedIn.value = true
                                    username.value = data.username
                                } else {
                                    isLoggedIn.value = false
                                    username.value = ''
                                }
                            } else {
                                isLoggedIn.value = true
                            }
                        } else {
                            console.error('Auth check failed with status:', res.status)
                        }
                    } catch (e) {
                        console.error('Auth check failed', e)
                    }
                }

                const login = async () => {
                    try {
                        const res = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(loginForm.value)
                        })
                        if (res.ok) {
                            const data = await res.json()
                            localStorage.setItem('auth_token', data.token)
                            isLoggedIn.value = true
                            username.value = data.username
                            loginForm.value = { username: '', password: '' }
                            fetchClients()
                            fetchGroups()
                            fetchScripts()
                            fetchHistory()
                            fetchUpdates()
                        } else {
                            alert(t('loginFailed'))
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const logout = async () => {
                    try {
                        const token = localStorage.getItem('auth_token')
                        await fetch('/api/auth/logout', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                    } catch (e) {}
                    localStorage.removeItem('auth_token')
                    isLoggedIn.value = false
                    username.value = ''
                    window.location.reload()
                }

                const changePassword = async () => {
                    try {
                        const token = localStorage.getItem('auth_token')
                        const res = await fetch('/api/auth/password', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(passwordForm.value)
                        })
                        if (res.ok) {
                            alert(t('passwordChanged'))
                            showPasswordModal.value = false
                            passwordForm.value = { old_password: '', new_password: '' }
                        } else {
                            const txt = await res.text()
                            alert(t('passwordChangeFailed') + ': ' + txt)
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                // Dashboard Filter
                const searchQuery = ref('')
                const statusFilter = ref('all')

                const filteredClients = computed(() => {
                    return clients.value.filter(client => {
                        const q = searchQuery.value.toLowerCase()
                        const matchQuery = !q || 
                            (client.hostname && client.hostname.toLowerCase().includes(q)) ||
                            (client.alias && client.alias.toLowerCase().includes(q)) ||
                            (client.ip && client.ip.includes(q)) ||
                            (client.version && client.version.includes(q))
                        
                        const matchStatus = statusFilter.value === 'all' || client.status === statusFilter.value
                        
                        return matchQuery && matchStatus
                    })
                })

                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        return new Date(dateStr).toLocaleString();
                    } catch (e) {
                        return dateStr;
                    }
                }
                
                // Hardware Info
                const hardwareInfo = ref(null)

                // Shell
                const shellInput = ref('')
                const shellOutput = ref('')
                const shellOutputRef = ref(null)
                const shellFileInput = ref(null)

                watch(shellOutput, async () => {
                    await nextTick()
                    if (shellOutputRef.value) {
                        shellOutputRef.value.scrollTop = shellOutputRef.value.scrollHeight
                    }
                })

                // Files
                const currentPath = ref('.')
                const fileList = ref([])
                const fileInput = ref(null)
                
                // Editor
                const editorFile = ref(null)
                const editorContent = ref('')

                // Groups
                const groupList = ref([])
                const selectedGroup = ref(null)
                const isCreatingGroup = ref(false)
                const newGroup = ref({ name: '', client_ids: [], script_ids: [] })

                // Scripts
                const scriptList = ref([])
                const selectedScript = ref(null)
                const isCreatingScript = ref(false)
                const newScript = ref({ name: '', steps: [] })
                const scriptStatus = ref(null)
                const selectedClientIds = ref([])

                // History
                const historyList = ref([])
                const selectedLogs = ref([])
                const executionList = ref([])
                const viewingExecutionId = ref(null)
                const viewingExecution = computed(() => executionList.value.find(e => e.execution_id === viewingExecutionId.value))
                let executionPollTimer = null

                // Updates
                const updateList = ref([])
                const selectedUpdate = ref(null)
                const newUpdate = ref({ version: '', platform: 'windows' })
                const updateFileInput = ref(null)

                // Layout
                const isMaximized = ref(false)
                const isMenuOpen = ref(false)
                
                const toggleMaximize = () => {
                    isMaximized.value = !isMaximized.value
                }

                const toggleMenu = () => {
                    isMenuOpen.value = !isMenuOpen.value
                }

                // I18n
                const lang = ref('zh')
                const messages = {
                    en: {
                        dashboardTitle: 'Roam Dashboard',
                        connectedClients: 'Connected Clients',
                        alias: 'Alias',
                        hostname: 'Hostname',
                        ipAddress: 'IP Address',
                        os: 'OS',
                        version: 'Version',
                        id: 'ID',
                        lastSeen: 'Last Seen',
                        actions: 'Actions',
                        noClients: 'No clients connected.',
                        hardware: 'Hardware',
                        shell: 'Shell',
                        files: 'Files',
                        update: 'Update',
                        hardwareInfo: 'Hardware Info',
                        loading: 'Loading...',
                        platform: 'Platform',
                        cpuUsage: 'CPU Usage',
                        totalMemory: 'Total Memory',
                        usedMemory: 'Used Memory',
                        failedInfo: 'Failed to fetch info or no data yet',
                        close: 'Close',
                        remoteShell: 'Remote Shell',
                        maximize: 'Maximize',
                        restore: 'Restore',
                        enterCommand: 'Enter command (e.g. ls -la)',
                        run: 'Run',
                        fileBrowser: 'File Browser',
                        uploadToClient: 'Upload to Client',
                        name: 'Name',
                        size: 'Size',
                        type: 'Type',
                        action: 'Action',
                        download: 'Download',
                        preview: 'Preview',
                        viewingEditing: 'Viewing/Editing',
                        closeCancel: 'Close/Cancel',
                        saveChanges: 'Save Changes',
                        updateClient: 'Update Client',
                        currentVersion: 'Current Version',
                        updateUrl: 'Update URL',
                        cancel: 'Cancel',
                        startUpdate: 'Start Update',
                        updating: 'Updating...',
                        switchLang: '‰∏≠Êñá',
                        scripts: 'Scripts',
                        scriptManager: 'Script Manager',
                        createScript: 'Create Script',
                        scriptName: 'Script Name',
                        steps: 'Steps',
                        addStep: 'Add Step',
                        stepType: 'Type',
                        command: 'Command',
                        args: 'Arguments (space separated)',
                        localPath: 'Local Path (Server)',
                        remotePath: 'Remote Path (Client)',
                        remove: 'Remove',
                        saveScript: 'Save Script',
                        runScript: 'Run Script',
                        selectScript: 'Select Script to Run',
                        running: 'Running...',
                        scriptStarted: 'Script execution started',
                        dashboard: 'Dashboard',
                        history: 'History',
                        executionHistory: 'Execution History',
                        time: 'Time',
                        client: 'Client',
                        logs: 'Logs',
                        selectClients: 'Select Clients to Execute Script',
                        startExecution: 'Start Execution',
                        editScript: 'Edit Script',
                        runScript: 'Run Script',
                        stepType: 'Step Type',
                        localPath: 'Local Path (Server)',
                        remotePath: 'Remote Path (Client)',
                        args: 'Arguments',
                        cancel: 'Cancel',
                        saveScript: 'Save Script',
                        executionLogs: 'Execution Logs',
                        selectClients: 'Select Clients',
                        clearLogs: 'Clear Logs',
                        logsCleared: 'Logs cleared successfully',
                        refresh: 'Refresh',
                        upload: 'Upload',
                        online: 'Online',
                        offline: 'Offline',
                        groups: 'Groups',
                        groupManager: 'Group Manager',
                        createGroup: 'Create Group',
                        groupName: 'Group Name',
                        editGroup: 'Edit Group',
                        clients: 'Clients',
                        save: 'Save',
                        bindScripts: 'Bind Script Groups',
                        boundScripts: 'Scripts',
                        runBoundScripts: 'Run Scripts',
                        noScripts: 'No scripts available',
                        executionMonitor: 'Execution Monitor',
                        noActiveExecutions: 'No active executions',
                        progress: 'Progress',
                        latestLog: 'Latest Log',
                        confirmRunGroup: 'Are you sure you want to run bound scripts for this group?',
                        executionStarted: 'Execution started',
                        viewLogs: 'View Logs',
                        downloadLogs: 'Download Logs',
                        liveLogs: 'Live Logs',
                        back: 'Back',
                        updateManager: 'Update Manager',
                        uploadUpdate: 'Upload Update',
                        version: 'Version',
                        platform: 'Platform',
                        filename: 'Filename',
                        uploadedAt: 'Uploaded At',
                        noUpdates: 'No update packages found.',
                        deploy: 'Deploy',
                        delete: 'Delete',
                        uploadUpdatePackage: 'Upload Update Package',
                        file: 'File',
                        uploading: 'Uploading...',
                        deployUpdate: 'Deploy Update',
                        selectClientsToUpdate: 'Select Clients to Update',
                        startUpdate: 'Start Update',
                        uploadFile: 'Upload File',
                        downloadFile: 'Download File',
                        browserDownload: 'Direct Browser Download',
                        uploadDir: 'Upload Directory',
                        downloadDir: 'Download Directory',
                        updates: 'Updates',
                        searchPlaceholder: 'Search hostname, alias, IP...',
                        allStatus: 'All Status',
                        openLink: 'Open Link',
                        login: 'Login',
                        username: 'Username',
                        password: 'Password',
                        loginFailed: 'Login Failed',
                        logout: 'Logout',
                        changePassword: 'Change Password',
                        oldPassword: 'Old Password',
                        newPassword: 'New Password',
                        passwordChanged: 'Password changed successfully',
                        passwordChangeFailed: 'Failed to change password',
                        archiveContents: 'Archive Contents',
                        items: 'items',
                        date: 'Date',
                        previewError: 'Preview failed or unsupported format',
                        confirmDeleteClient: 'Are you sure you want to remove this client?',
                    },
                    zh: {
                        dashboardTitle: 'Roam ÊéßÂà∂Âè∞',
                        connectedClients: 'Â∑≤ËøûÊé•ÂÆ¢Êà∑Á´Ø',
                        alias: 'Âà´Âêç',
                        hostname: '‰∏ªÊú∫Âêç',
                        ipAddress: 'IP Âú∞ÂùÄ',
                        os: 'Êìç‰ΩúÁ≥ªÁªü',
                        version: 'ÁâàÊú¨',
                        id: 'ID',
                        lastSeen: 'ÊúÄÂêéÂøÉË∑≥',
                        actions: 'Êìç‰Ωú',
                        noClients: 'ÊöÇÊó†ÂÆ¢Êà∑Á´ØËøûÊé•',
                        hardware: 'Á°¨‰ª∂‰ø°ÊÅØ',
                        shell: 'ÁªàÁ´Ø',
                        files: 'Êñá‰ª∂ÁÆ°ÁêÜ',
                        update: 'Êõ¥Êñ∞',
                        hardwareInfo: 'Á°¨‰ª∂‰ø°ÊÅØ',
                        loading: 'Âä†ËΩΩ‰∏≠...',
                        platform: 'Âπ≥Âè∞',
                        cpuUsage: 'CPU ‰ΩøÁî®Áéá',
                        totalMemory: 'ÊÄªÂÜÖÂ≠ò',
                        usedMemory: 'Â∑≤Áî®ÂÜÖÂ≠ò',
                        failedInfo: 'Ëé∑Âèñ‰ø°ÊÅØÂ§±Ë¥•ÊàñÊöÇÊó†Êï∞ÊçÆ',
                        close: 'ÂÖ≥Èó≠',
                        remoteShell: 'ËøúÁ®ãÁªàÁ´Ø',
                        maximize: 'ÊúÄÂ§ßÂåñ',
                        restore: 'ËøòÂéü',
                        enterCommand: 'ËæìÂÖ•ÂëΩ‰ª§ (Â¶Ç ls -la)',
                        run: 'ËøêË°å',
                        fileBrowser: 'Êñá‰ª∂ÊµèËßà',
                        uploadToClient: '‰∏ä‰º†Âà∞ÂÆ¢Êà∑Á´Ø',
                        name: 'ÂêçÁß∞',
                        size: 'Â§ßÂ∞è',
                        type: 'Á±ªÂûã',
                        action: 'Êìç‰Ωú',
                        download: '‰∏ãËΩΩ',
                        preview: 'È¢ÑËßà',
                        viewingEditing: 'Ê≠£Âú®Êü•Áúã/ÁºñËæë',
                        closeCancel: 'ÂÖ≥Èó≠/ÂèñÊ∂à',
                        saveChanges: '‰øùÂ≠òÊõ¥Êîπ',
                        updateClient: 'Êõ¥Êñ∞ÂÆ¢Êà∑Á´Ø',
                        currentVersion: 'ÂΩìÂâçÁâàÊú¨',
                        updateUrl: 'Êõ¥Êñ∞ÈìæÊé•',
                        cancel: 'ÂèñÊ∂à',
                        startUpdate: 'ÂºÄÂßãÊõ¥Êñ∞',
                        updating: 'Êõ¥Êñ∞‰∏≠...',
                        switchLang: 'English',
                        scripts: 'ËÑöÊú¨ÁªÑ',
                        scriptManager: 'ËÑöÊú¨ÁªÑÁÆ°ÁêÜ',
                        createScript: 'ÂàõÂª∫ËÑöÊú¨ÁªÑ',
                        scriptName: 'ËÑöÊú¨ÂêçÁß∞',
                        steps: 'Ê≠•È™§',
                        addStep: 'Ê∑ªÂä†Ê≠•È™§',
                        stepType: 'Á±ªÂûã',
                        command: 'ÂëΩ‰ª§',
                        args: 'ÂèÇÊï∞ (Á©∫Ê†ºÂàÜÈöî)',
                        localPath: 'Êú¨Âú∞Ë∑ØÂæÑ (ÊúçÂä°Á´Ø)',
                        remotePath: 'ËøúÁ®ãË∑ØÂæÑ (ÂÆ¢Êà∑Á´Ø)',
                        remove: 'ÁßªÈô§',
                        saveScript: '‰øùÂ≠òËÑöÊú¨',
                        runScript: 'ËøêË°åËÑöÊú¨',
                        selectScript: 'ÈÄâÊã©Ë¶ÅËøêË°åÁöÑËÑöÊú¨',
                        running: 'ËøêË°å‰∏≠...',
                        scriptStarted: 'ËÑöÊú¨ÊâßË°åÂ∑≤ÂºÄÂßã',
                        dashboard: '‰ª™Ë°®Áõò',
                        confirmDeleteClient: 'Á°ÆÂÆöË¶ÅÁßªÈô§Ê≠§ÂÆ¢Êà∑Á´ØÂêóÔºü',
                        delete: 'Âà†Èô§',
                        history: 'ÂéÜÂè≤ËÆ∞ÂΩï',
                        executionHistory: 'ÊâßË°åÂéÜÂè≤',
                        time: 'Êó∂Èó¥',
                        client: 'ÂÆ¢Êà∑Á´Ø',
                        logs: 'Êó•Âøó',
                        selectClients: 'ÈÄâÊã©Ë¶ÅÊâßË°åËÑöÊú¨ÁöÑÂÆ¢Êà∑Á´Ø',
                        startExecution: 'ÂºÄÂßãÊâßË°å',
                        editScript: 'ÁºñËæëËÑöÊú¨',
                        runScript: 'ËøêË°åËÑöÊú¨',
                        stepType: 'Ê≠•È™§Á±ªÂûã',
                        localPath: 'Êú¨Âú∞Ë∑ØÂæÑ (ÊúçÂä°Á´Ø)',
                        remotePath: 'ËøúÁ®ãË∑ØÂæÑ (ÂÆ¢Êà∑Á´Ø)',
                        args: 'ÂèÇÊï∞',
                        cancel: 'ÂèñÊ∂à',
                        saveScript: '‰øùÂ≠òËÑöÊú¨',
                        executionLogs: 'ÊâßË°åÊó•Âøó',
                        selectClients: 'ÈÄâÊã©ÂÆ¢Êà∑Á´Ø',
                        clearLogs: 'Ê∏ÖÁ©∫Êó•Âøó',
                        logsCleared: 'Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫',
                        refresh: 'Âà∑Êñ∞',
                        upload: '‰∏ä‰º†',
                        online: 'Âú®Á∫ø',
                        offline: 'Á¶ªÁ∫ø',
                        status: 'Áä∂ÊÄÅ',
                        groups: 'ÂÆ¢Êà∑Á´ØÂàÜÁªÑ',
                        groupManager: 'ÂàÜÁªÑÁÆ°ÁêÜ',
                        createGroup: 'ÂàõÂª∫ÂàÜÁªÑ',
                        groupName: 'ÂàÜÁªÑÂêçÁß∞',
                        editGroup: 'ÁºñËæëÂàÜÁªÑ',
                        clients: 'ÂÆ¢Êà∑Á´Ø',
                        save: '‰øùÂ≠ò',
                        bindScripts: 'ÁªëÂÆöËÑöÊú¨ÁªÑ',
                        boundScripts: '‰∏™ËÑöÊú¨',
                        runBoundScripts: 'ÊâßË°åËÑöÊú¨',
                        noScripts: 'ÊöÇÊó†ËÑöÊú¨',
                        executionMonitor: 'ÊâßË°åÁõëÊéß',
                        noActiveExecutions: 'ÊöÇÊó†Ê¥ªÂä®ÊâßË°å‰ªªÂä°',
                        progress: 'ËøõÂ∫¶',
                        latestLog: 'ÊúÄÊñ∞Êó•Âøó',
                        confirmRunGroup: 'Á°ÆÂÆöË¶Å‰∏∫ËØ•ÂàÜÁªÑÊâßË°åÊâÄÊúâÁªëÂÆöÁöÑËÑöÊú¨ÂêóÔºü',
                        executionStarted: 'ÊâßË°åÂ∑≤ÂºÄÂßã',
                        viewLogs: 'Êü•ÁúãÊó•Âøó',
                        downloadLogs: '‰∏ãËΩΩÊó•Âøó',
                        liveLogs: 'ÂÆûÊó∂Êó•Âøó',
                        back: 'ËøîÂõû',
                        updateManager: 'Êõ¥Êñ∞ÁÆ°ÁêÜ',
                        uploadUpdate: '‰∏ä‰º†Êõ¥Êñ∞ÂåÖ',
                        version: 'ÁâàÊú¨',
                        platform: 'Âπ≥Âè∞',
                        filename: 'Êñá‰ª∂Âêç',
                        uploadedAt: '‰∏ä‰º†Êó∂Èó¥',
                        noUpdates: 'ÊöÇÊó†Êõ¥Êñ∞ÂåÖ',
                        deploy: 'ÈÉ®ÁΩ≤',
                        delete: 'Âà†Èô§',
                        uploadUpdatePackage: '‰∏ä‰º†Êõ¥Êñ∞ÂåÖ',
                        file: 'Êñá‰ª∂',
                        uploading: '‰∏ä‰º†‰∏≠...',
                        deployUpdate: 'ÈÉ®ÁΩ≤Êõ¥Êñ∞',
                        selectClientsToUpdate: 'ÈÄâÊã©Ë¶ÅÊõ¥Êñ∞ÁöÑÂÆ¢Êà∑Á´Ø',
                        startUpdate: 'ÂºÄÂßãÊõ¥Êñ∞',
                        uploadFile: '‰∏ä‰º†Êñá‰ª∂',
                        downloadFile: '‰∏ãËΩΩÊñá‰ª∂',
                        browserDownload: '‰ΩøÁî®ÊµèËßàÂô®Áõ¥Êé•‰∏ãËΩΩ',
                        uploadDir: '‰∏ä‰º†Êñá‰ª∂Â§π',
                        downloadDir: '‰∏ãËΩΩÊñá‰ª∂Â§π',
                        updates: 'Êõ¥Êñ∞ÁÆ°ÁêÜ',
                        searchPlaceholder: 'ÊêúÁ¥¢‰∏ªÊú∫Âêç„ÄÅÂà´Âêç„ÄÅIP...',
                        allStatus: 'ÂÖ®ÈÉ®Áä∂ÊÄÅ',
                        openLink: 'ÊâìÂºÄÈìæÊé•',
                        login: 'ÁôªÂΩï',
                        username: 'Áî®Êà∑Âêç',
                        password: 'ÂØÜÁ†Å',
                        loginFailed: 'ÁôªÂΩïÂ§±Ë¥•',
                        logout: 'ÈÄÄÂá∫ÁôªÂΩï',
                        changePassword: '‰øÆÊîπÂØÜÁ†Å',
                        oldPassword: 'ÊóßÂØÜÁ†Å',
                        newPassword: 'Êñ∞ÂØÜÁ†Å',
                        passwordChanged: 'ÂØÜÁ†Å‰øÆÊîπÊàêÂäü',
                        passwordChangeFailed: 'ÂØÜÁ†Å‰øÆÊîπÂ§±Ë¥•',
                        archiveContents: 'ÂéãÁº©ÂåÖÂÜÖÂÆπ',
                        items: 'È°π',
                        date: 'Êó•Êúü',
                        previewError: 'È¢ÑËßàÂ§±Ë¥•Êàñ‰∏çÊîØÊåÅÁöÑÊ†ºÂºè',
                    }
                }

                const t = (key) => {
                    const val = messages[lang.value][key]
                    if (!val) {
                        // Fallback to English if translation missing
                        return messages['en'][key] || key
                    }
                    return val
                }

                const toggleLang = () => {
                    lang.value = lang.value === 'en' ? 'zh' : 'en'
                }

                const fetchClients = async () => {
                    if (authEnabled.value && !isLoggedIn.value) return
                    try {
                        const res = await apiFetch('/api/clients')
                        if (res.ok) {
                            clients.value = await res.json()
                        }
                    } catch (e) {
                        if (e.message !== 'Unauthorized') console.error(e)
                    }
                }

                const fetchServerInfo = async () => {
                    try {
                        const res = await apiFetch('/api/info')
                        if (res.ok) {
                            serverInfo.value = await res.json()
                        }
                    } catch (e) {
                        if (e.message !== 'Unauthorized') console.error(e)
                    }
                }

                // Polling for client list
                setInterval(fetchClients, 5000)
                onMounted(() => {
                    checkAuth()
                    // fetchClients() - will be handled by interval or after login
                    fetchServerInfo()
                })

                const getAuthHeaders = () => {
                    const token = localStorage.getItem('auth_token')
                    return token ? { 'Authorization': `Bearer ${token}` } : {}
                }

                const apiFetch = async (url, options = {}) => {
                    const headers = { ...getAuthHeaders(), ...(options.headers || {}) }
                    const res = await fetch(url, { ...options, headers })
                    if (res.status === 401 && authEnabled.value) {
                        isLoggedIn.value = false
                        username.value = ''
                        localStorage.removeItem('auth_token')
                        throw new Error('Unauthorized')
                    }
                    return res
                }

                const pollResult = async (cmdId) => {
                    const maxRetries = 600; // 5 minutes
                    for (let i = 0; i < maxRetries; i++) {
                        try {
                            const res = await apiFetch(`/api/commands/${cmdId}/result`);
                            if (res.ok) {
                                const result = await res.json();
                                return result;
                            }
                        } catch (e) {}
                        await new Promise(r => setTimeout(r, 500));
                    }
                    throw new Error("Command timed out");
                };

                const sendCommand = async (clientId, payload, waitForResult = true) => {
                    commandLoading.value = true
                    try {
                        const res = await apiFetch(`/api/clients/${clientId}/command`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        if (!res.ok) throw new Error('Command failed to send')
                        const cmdId = await res.text()
                        
                        if (!waitForResult) return { status: 'Sent', id: cmdId };

                        // Poll for result
                        const result = await pollResult(cmdId);
                        
                        // Handle Result Types
                        if (result.status === 'Error') {
                            throw new Error(result.data);
                        }
                        
                        return result;
                    } catch (e) {
                        console.error(e)
                        throw e // Propagate error
                    } finally {
                        commandLoading.value = false
                    }
                }

                const openHardware = async (client) => {
                    selectedClient.value = client
                    activeModal.value = 'hardware'
                    hardwareInfo.value = null
                    try {
                        const result = await sendCommand(client.id, { cmd_type: 'GetHardwareInfo' })
                        if (result && result.status === 'HardwareInfo') {
                            hardwareInfo.value = result.data
                        }
                    } catch (e) {
                        // Error handled in UI via v-else
                    }
                }

                const openShell = (client) => {
                    selectedClient.value = client
                    activeModal.value = 'shell'
                    shellOutput.value = 'Ready to execute commands...'
                    shellInput.value = ''
                    isMaximized.value = false
                }

                const runShellCommand = async () => {
                    if (!shellInput.value.trim()) return
                    const cmd = shellInput.value.trim()
                    const parts = cmd.split(' ')
                    const command = parts[0]
                    const args = parts.slice(1)
                    
                    shellOutput.value += `\n> ${cmd}\n`
                    
                    try {
                        const result = await sendCommand(selectedClient.value.id, { 
                            cmd_type: 'ShellExec', 
                            args: { cmd: command, args: args } 
                        })
                        
                        if (result && result.status === 'ShellOutput') {
                            shellOutput.value += result.data.stdout + result.data.stderr;
                        } else if (result && result.status === 'Error') {
                            shellOutput.value += `Error: ${result.data}\n`;
                        }
                    } catch (e) {
                        shellOutput.value += `Error: ${e.message}\n`;
                    }
                    
                    shellInput.value = ''
                }

                const triggerShellUpload = () => {
                    shellFileInput.value.click()
                }

                const handleShellUpload = async (event) => {
                    const file = event.target.files[0]
                    if (!file) return
                    
                    const formData = new FormData()
                    formData.append('file', file)
                    
                    shellOutput.value += `\n> Uploading ${file.name}...\n`
                    
                    try {
                        const res = await apiFetch('/api/files/admin-upload', {
                            method: 'POST',
                            body: formData
                        })
                        if (!res.ok) throw new Error('Server upload failed')
                        const data = await res.json()
                        const downloadUrl = data.url
                        
                        // Use relative path (filename only) to upload to current shell directory
                        const destPath = file.name
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'DownloadFile',
                            args: { url: downloadUrl, dest_path: destPath }
                        })
                        
                        if (result && result.status === 'Success') {
                            shellOutput.value += `Success: File uploaded to current directory.\n`
                        } else {
                            throw new Error(result.data || 'Client failed to download')
                        }
                    } catch (e) {
                        shellOutput.value += `Error: Upload failed: ${e.message}\n`
                    } finally {
                        event.target.value = ''
                    }
                }

                const openFiles = (client) => {
                    selectedClient.value = client
                    activeModal.value = 'files'
                    
                    // Determine initial path based on OS
                    let initialPath = '~' // Default for Linux/macOS
                    if (client.os && client.os.toLowerCase().includes('windows')) {
                        initialPath = 'C:\\'
                    }
                    
                    currentPath.value = initialPath
                    listFiles(initialPath)
                    isMaximized.value = false
                }

                const listFiles = async (path) => {
                    currentPath.value = path
                    fileList.value = []
                    try {
                        const result = await sendCommand(selectedClient.value.id, { 
                            cmd_type: 'ListDir', 
                            args: { path: path } 
                        })
                        
                        if (result && result.status === 'FileList') {
                            fileList.value = result.data.files.sort((a, b) => {
                                if (a.is_dir === b.is_dir) return a.name.localeCompare(b.name);
                                return a.is_dir ? -1 : 1;
                            });
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const triggerFileUpload = () => {
                    fileInput.value.click()
                }

                const handleFileUpload = async (event) => {
                    const file = event.target.files[0]
                    if (!file) return
                    
                    const formData = new FormData()
                    formData.append('file', file)
                    
                    commandLoading.value = true
                    try {
                        const res = await apiFetch('/api/files/admin-upload', {
                            method: 'POST',
                            body: formData
                        })
                        if (!res.ok) throw new Error('Server upload failed')
                        const data = await res.json()
                        const downloadUrl = data.url
                        
                        const destPath = joinPath(currentPath.value, file.name)
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'DownloadFile',
                            args: { url: downloadUrl, dest_path: destPath }
                        })
                        
                        if (result && result.status === 'Success') {
                            alert('File uploaded to client successfully!')
                            listFiles(currentPath.value)
                        } else {
                            throw new Error(result.data || 'Client failed to download')
                        }
                    } catch (e) {
                        alert('Upload failed: ' + e.message)
                    } finally {
                        commandLoading.value = false
                        event.target.value = ''
                    }
                }

                const fetchClientFile = async (file) => {
                    const uploadId = crypto.randomUUID();
                    const host = window.location.host;
                    const uploadUrl = `http://${host}/api/files/client-upload/${uploadId}`;
                    
                    const srcPath = joinPath(currentPath.value, file.name);
                    
                    const result = await sendCommand(selectedClient.value.id, {
                        cmd_type: 'UploadFile',
                        args: { src_path: srcPath, upload_url: uploadUrl }
                    });
                    
                    if (result && result.status === 'Success') {
                         return `/api/files/download/client_data/${uploadId}/${encodeURIComponent(file.name)}`;
                    } else {
                         throw new Error(result?.data || 'Unknown error');
                    }
                }

                const downloadFromClient = async (file) => {
                    if (!confirm(`Download ${file.name}?`)) return
                    
                    try {
                        const serverDownloadUrl = await fetchClientFile(file);
                        window.open(serverDownloadUrl, '_blank');
                    } catch (e) {
                        alert('Download failed: ' + e.message);
                    }
                }

                const deleteClient = async (client) => {
                    if (!confirm(t('confirmDeleteClient'))) return;
                    try {
                        const res = await apiFetch(`/api/clients/${client.id}`, { method: 'DELETE' });
                        if (res.ok) {
                            await fetchClients();
                        } else {
                            const err = await res.text();
                            alert('Failed to delete client: ' + err);
                        }
                    } catch (e) {
                        alert(e.message);
                    }
                }

                // Preview
                const previewFile = ref(null);
                const previewUrl = ref('');
                const previewType = ref('');
                const previewContent = ref('');
                const previewItems = ref([]);
                const docxContainer = ref(null);
                const previewLoading = ref(false);

                const openPreview = async (file, type) => {
                    previewFile.value = file;
                    previewType.value = type;
                    previewUrl.value = '';
                    previewContent.value = '';
                    previewItems.value = [];
                    activeModal.value = 'preview';
                    isMaximized.value = false;
                    previewLoading.value = true;
                    
                    try {
                        const url = await fetchClientFile(file);
                        previewUrl.value = url;

                        if (type === 'docx') {
                            const res = await fetch(url);
                            const blob = await res.blob();
                            await nextTick();
                            if (docxContainer.value) {
                                try {
                                    await docx.renderAsync(blob, docxContainer.value);
                                } catch (e) {
                                    console.error(e);
                                    previewContent.value = '<div class="text-red-500 p-4">Failed to render DOCX: ' + e.message + '</div>';
                                }
                            }
                        } else if (type === 'xlsx') {
                            const res = await fetch(url);
                            const ab = await res.arrayBuffer();
                            const wb = XLSX.read(ab, {type: 'array'});
                            const sheetName = wb.SheetNames[0];
                            const sheet = wb.Sheets[sheetName];
                            const html = XLSX.utils.sheet_to_html(sheet);
                            previewContent.value = html;
                        } else if (type === 'zip') {
                            const res = await fetch(url);
                            if (!res.ok) throw new Error(`Failed to fetch zip file: ${res.status} ${res.statusText}`);
                            const blob = await res.blob();
                            
                            if (!window.JSZip) throw new Error("JSZip library not loaded");
                            const zip = await JSZip.loadAsync(blob);
                            
                            const items = [];
                            zip.forEach((relativePath, zipEntry) => {
                                items.push({
                                    name: zipEntry.name,
                                    dir: zipEntry.dir,
                                    date: zipEntry.date,
                                    size: (zipEntry._data && zipEntry._data.uncompressedSize) || 0
                                });
                            });
                            previewItems.value = items.sort((a, b) => (a.dir === b.dir ? 0 : a.dir ? -1 : 1));
                        }
                    } catch (e) {
                        alert('Preview failed: ' + e.message);
                        closePreview();
                    } finally {
                        previewLoading.value = false;
                    }
                }

                const closePreview = () => {
                    activeModal.value = 'files';
                    previewFile.value = null;
                    previewUrl.value = '';
                    previewType.value = '';
                    previewContent.value = '';
                    previewItems.value = [];
                    if (docxContainer.value) docxContainer.value.innerHTML = '';
                }

                const openFileHandler = (file) => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const images = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'ico'];
                    const videos = ['mp4', 'webm', 'ogg', 'mov'];
                    const audios = ['mp3', 'wav', 'ogg'];
                    const office = ['xlsx', 'xls', 'csv'];
                    
                    if (images.includes(ext)) {
                        openPreview(file, 'image');
                    } else if (videos.includes(ext)) {
                        openPreview(file, 'video');
                    } else if (audios.includes(ext)) {
                        openPreview(file, 'audio');
                    } else if (ext === 'pdf') {
                         openPreview(file, 'pdf');
                    } else if (ext === 'docx') {
                         openPreview(file, 'docx');
                    } else if (office.includes(ext)) {
                         openPreview(file, 'xlsx');
                    } else if (ext === 'zip') {
                         openPreview(file, 'zip');
                    } else {
                        openEditor(file);
                    }
                }

                const openEditor = async (file) => {
                    editorFile.value = file;
                    editorContent.value = '';
                    activeModal.value = 'editor';
                    isMaximized.value = false;
                    
                    try {
                        const filePath = joinPath(currentPath.value, file.name);
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'ReadFile',
                            args: { path: filePath }
                        });
                        
                        if (result && result.status === 'FileContent') {
                            editorContent.value = result.data.content;
                        } else {
                            alert('Failed to read file: ' + (result?.data || 'Unknown error'));
                            closeEditor();
                        }
                    } catch (e) {
                        alert('Error opening file: ' + e.message);
                        closeEditor();
                    }
                }

                const closeEditor = () => {
                    activeModal.value = 'files'; // Go back to files
                    editorFile.value = null;
                }

                const saveFile = async () => {
                    if (!editorFile.value) return;
                    
                    try {
                        const filePath = joinPath(currentPath.value, editorFile.value.name);
                        const result = await sendCommand(selectedClient.value.id, {
                            cmd_type: 'WriteFile',
                            args: { path: filePath, content: editorContent.value }
                        });
                        
                        if (result && result.status === 'Success') {
                            alert('File saved successfully!');
                            closeEditor();
                            listFiles(currentPath.value); // Refresh
                        } else {
                            alert('Failed to save file: ' + (result?.data || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Error saving file: ' + e.message);
                    }
                }

                const openScripts = async () => {
                     // No-op, used by tab
                }

                const fetchScripts = async () => {
                    try {
                        const res = await apiFetch('/api/scripts')
                        if (res.ok) {
                            scriptList.value = await res.json()
                        }
                    } catch (e) {
                        console.error('Failed to fetch scripts', e)
                    }
                }

                const fetchGroups = async () => {
                    try {
                        const res = await apiFetch('/api/groups')
                        if (res.ok) {
                            groupList.value = await res.json()
                        }
                    } catch (e) {
                        console.error('Failed to fetch groups', e)
                    }
                }

                const startExecutionPolling = () => {
                    stopExecutionPolling()
                    executionPollTimer = setInterval(async () => {
                        if (activeModal.value !== 'executionMonitor') {
                            stopExecutionPolling()
                            return
                        }
                        try {
                            const res = await apiFetch('/api/executions/active')
                            if (res.ok) {
                                executionList.value = await res.json()
                            }
                        } catch (e) {
                            console.error(e)
                        }
                    }, 1000)
                }

                const stopExecutionPolling = () => {
                    if (executionPollTimer) {
                        clearInterval(executionPollTimer)
                        executionPollTimer = null
                    }
                }

                const runGroupScripts = async (group) => {
                    if (!confirm(t('confirmRunGroup'))) return
                    
                    try {
                        const res = await apiFetch(`/api/groups/${group.id}/run`, { method: 'POST' })
                        if (res.ok) {
                            alert(t('executionStarted'))
                            activeModal.value = 'executionMonitor'
                            executionList.value = []
                            startExecutionPolling()
                        } else {
                            const txt = await res.text()
                            alert('Failed: ' + txt)
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const openGroupEditor = (group = null) => {
                    activeModal.value = 'groupEditor'
                    fetchScripts() // Ensure scripts are loaded
                    if (group) {
                        isCreatingGroup.value = false
                        selectedGroup.value = group
                        newGroup.value = { 
                            name: group.name, // Name is not editable in update, only members
                            client_ids: [...group.client_ids],
                            script_ids: group.script_ids ? [...group.script_ids] : []
                        }
                    } else {
                        isCreatingGroup.value = true
                        selectedGroup.value = null
                        newGroup.value = { name: '', client_ids: [], script_ids: [] }
                    }
                }

                const saveGroup = async () => {
                    try {
                        let res;
                        if (isCreatingGroup.value) {
                            if (!newGroup.value.name) return alert('Name required')
                            
                            // 1. Create Group
                            res = await apiFetch('/api/groups', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name: newGroup.value.name })
                            })
                            
                            if (res.ok) {
                                const data = await res.json()
                                // 2. Update Members & Scripts
                                const updates = {}
                                if (newGroup.value.client_ids.length > 0) updates.client_ids = newGroup.value.client_ids
                                if (newGroup.value.script_ids.length > 0) updates.script_ids = newGroup.value.script_ids
                                
                                if (Object.keys(updates).length > 0) {
                                    await apiFetch(`/api/groups/${data.id}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(updates)
                                    })
                                }
                            }
                        } else {
                            // Update Members & Scripts
                            const updates = {
                                client_ids: newGroup.value.client_ids,
                                script_ids: newGroup.value.script_ids
                            }
                            res = await apiFetch(`/api/groups/${selectedGroup.value.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updates)
                            })
                        }
                        
                        if (res.ok) {
                            await fetchGroups()
                            closeModal()
                        } else {
                            alert('Failed to save group')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const deleteGroup = async (id) => {
                    if (!confirm('Are you sure you want to delete this group?')) return;
                    try {
                        const res = await apiFetch(`/api/groups/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            await fetchGroups();
                        } else {
                            alert('Failed to delete group');
                        }
                    } catch (e) {
                        alert(e.message);
                    }
                }

                const openScriptEditor = (script = null) => {
                    activeModal.value = 'scriptEditor'
                    if (script) {
                        isCreatingScript.value = false
                        selectedScript.value = script
                        // Deep copy to avoid modifying original until saved
                        const rawScript = JSON.parse(JSON.stringify(script))
                        
                        // Transform steps from payload format to flat format for UI
                        const steps = rawScript.steps.map(s => {
                            if (s.type === 'Shell') {
                                return { type: 'Shell', cmd: s.payload.cmd, args: s.payload.args.join(' ') }
                            } else if (s.type === 'Upload') {
                                return { type: 'Upload', local_path: s.payload.local_path, remote_path: s.payload.remote_path }
                            } else if (s.type === 'Download') {
                                return { type: 'Download', remote_path: s.payload.remote_path, browser_download: s.payload.browser_download || false }
                            } else if (s.type === 'UploadDir') {
                                return { type: 'UploadDir', local_path: s.payload.local_path, remote_path: s.payload.remote_path }
                            } else if (s.type === 'DownloadDir') {
                                return { type: 'DownloadDir', remote_path: s.payload.remote_path, browser_download: s.payload.browser_download || false }
                            }
                            return s
                        })
                        
                        newScript.value = { name: rawScript.name, steps }
                    } else {
                        isCreatingScript.value = true
                        selectedScript.value = null
                        newScript.value = { name: '', steps: [] }
                    }
                }

                const addStep = () => {
                    newScript.value.steps.push({ type: 'Shell', cmd: '', args: '', local_path: '', remote_path: '' })
                }

                const removeStep = (index) => {
                    newScript.value.steps.splice(index, 1)
                }

                const saveScript = async () => {
                    if (!newScript.value.name) return alert('Name required')
                    
                    const steps = newScript.value.steps.map(s => {
                        if (s.type === 'Shell') {
                            return { type: 'Shell', payload: { cmd: s.cmd, args: s.args.split(' ').filter(a => a) } }
                        } else if (s.type === 'Upload') {
                            return { type: 'Upload', payload: { local_path: s.local_path, remote_path: s.remote_path } }
                        } else if (s.type === 'Download') {
                            return { type: 'Download', payload: { remote_path: s.remote_path, browser_download: s.browser_download } }
                        } else if (s.type === 'UploadDir') {
                            return { type: 'UploadDir', payload: { local_path: s.local_path, remote_path: s.remote_path } }
                        } else if (s.type === 'DownloadDir') {
                            return { type: 'DownloadDir', payload: { remote_path: s.remote_path, browser_download: s.browser_download } }
                        }
                        return null
                    }).filter(s => s)

                    const payload = { name: newScript.value.name, steps }
                    
                    try {
                        let res;
                        if (isCreatingScript.value) {
                             res = await apiFetch('/api/scripts', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            })
                        } else {
                             res = await apiFetch(`/api/scripts/${selectedScript.value.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            })
                        }
                        
                        if (res.ok) {
                            await fetchScripts()
                            closeModal()
                        } else {
                            alert('Failed to save script')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }
                
                const deleteScript = async (id) => {
                    if (!confirm('Are you sure you want to delete this script?')) return;
                    try {
                        const res = await apiFetch(`/api/scripts/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            await fetchScripts();
                        } else {
                            alert('Failed to delete script');
                        }
                    } catch (e) {
                        alert(e.message);
                    }
                }

                const openRunScript = (script) => {
                    selectedScript.value = script
                    selectedClientIds.value = []
                    activeModal.value = 'runScript'
                }

                const executeScript = async () => {
                    if (!selectedScript.value || selectedClientIds.value.length === 0) return
                    
                    try {
                        const res = await apiFetch(`/api/scripts/${selectedScript.value.id}/run`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ client_ids: selectedClientIds.value })
                        })
                        
                        if (res.ok) {
                            alert(t('scriptStarted'))
                            closeModal()
                            currentView.value = 'history'
                            fetchHistory()
                        } else {
                            const err = await res.text()
                            alert('Failed to start script: ' + err)
                        }
                    } catch (e) {
                        alert('Error: ' + e.message)
                    }
                }

                const fetchHistory = async () => {
                    try {
                        const res = await apiFetch('/api/history')
                        if (res.ok) {
                            historyList.value = await res.json()
                        }
                    } catch (e) {
                        console.error('Failed to fetch history', e)
                    }
                }

                const clearHistory = async () => {
                    if (!confirm(t('clearLogs') + '?')) return
                    try {
                        const res = await apiFetch('/api/history', { method: 'DELETE' })
                        if (res.ok) {
                            alert(t('logsCleared'))
                            fetchHistory()
                        } else {
                            alert('Failed to clear logs')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }
                
                const viewLogs = (item) => {
                    selectedLogs.value = item.logs
                    // Extract execution ID from item or use a temp one if not present (though history items should have one)
                    // If the item comes from history list, it has an ID.
                    // We'll use a reactive variable to hold the current item for context in the modal
                    currentLogItem.value = item
                    activeModal.value = 'logs'
                    isMaximized.value = false
                }

                const currentLogItem = ref(null)

                const downloadLogFile = () => {
                    if (!currentLogItem.value) return
                    const content = selectedLogs.value.join('\n')
                    const blob = new Blob([content], { type: 'text/plain' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    // Filename: logs_{script_name}_{client}_{time}.txt
                    const time = new Date(currentLogItem.value.started_at || Date.now()).toISOString().replace(/[:.]/g, '-')
                    a.download = `logs_${currentLogItem.value.script_name || 'script'}_${currentLogItem.value.client_hostname || 'client'}_${time}.txt`
                    document.body.appendChild(a)
                    a.click()
                    document.body.removeChild(a)
                    URL.revokeObjectURL(url)
                }

                const downloadArtifact = (logLine) => {
                    // Try to parse artifact URL from log line
                    // Format usually: "File uploaded successfully: http://.../api/files/client-upload/..."
                    // Or "BROWSER_DOWNLOAD: http://..."
                    
                    let url = null;
                    let isDownload = false;

                    if (logLine.includes('BROWSER_DOWNLOAD:')) {
                        const parts = logLine.split('BROWSER_DOWNLOAD:');
                        if (parts.length > 1) {
                            url = parts[1].trim();
                            isDownload = true;
                        }
                    } else {
                         const match = logLine.match(/http:\/\/[^\s]+/)
                         if (match) {
                              url = match[0]
                         }
                    }

                    if (url) {
                         if (isDownload) {
                             const a = document.createElement('a');
                             a.href = url;
                             a.download = ''; 
                             document.body.appendChild(a);
                             a.click();
                             document.body.removeChild(a);
                         } else {
                             window.open(url, '_blank')
                         }
                    }
                }

                // Automatic Browser Download
                const processedDownloads = new Set();
                
                watch(executionList, (newVal) => {
                    if (!newVal) return;
                    
                    newVal.forEach(exec => {
                        if (!exec.logs) return;
                        
                        exec.logs.forEach(log => {
                            if (log.includes('BROWSER_DOWNLOAD:')) {
                                const parts = log.split('BROWSER_DOWNLOAD:');
                                if (parts.length > 1) {
                                    const url = parts[1].trim();
                                    if (!processedDownloads.has(url)) {
                                        processedDownloads.add(url);
                                        // Trigger download
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = ''; 
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                    }
                                }
                            }
                        });
                    });
                }, { deep: true });

                const navigateUp = () => {
                     const parts = currentPath.value.split(/[/\\]/);
                     parts.pop();
                     const newPath = parts.join('/') || '.';
                     listFiles(newPath);
                }
                
                const fetchUpdates = async () => {
                    try {
                        const res = await apiFetch('/api/updates')
                        if (res.ok) {
                            updateList.value = await res.json()
                        }
                    } catch (e) {
                        console.error(e)
                    }
                }

                const openUploadUpdateModal = () => {
                    activeModal.value = 'uploadUpdate'
                    newUpdate.value = { version: '', platform: 'windows' }
                    if (updateFileInput.value) updateFileInput.value.value = ''
                }

                const uploadUpdate = async () => {
                    if (!newUpdate.value.version || !updateFileInput.value?.files[0]) {
                        return alert('Please fill all fields')
                    }
                    
                    const formData = new FormData()
                    formData.append('version', newUpdate.value.version)
                    formData.append('platform', newUpdate.value.platform)
                    formData.append('file', updateFileInput.value.files[0])
                    
                    commandLoading.value = true
                    try {
                        const res = await apiFetch('/api/updates', {
                            method: 'POST',
                            body: formData
                        })
                        
                        if (res.ok) {
                            alert('Update uploaded successfully')
                            closeModal()
                            fetchUpdates()
                        } else {
                            const txt = await res.text()
                            alert('Upload failed: ' + txt)
                        }
                    } catch (e) {
                        alert(e.message)
                    } finally {
                        commandLoading.value = false
                    }
                }

                const deleteUpdate = async (id) => {
                    if (!confirm('Are you sure you want to delete this update?')) return
                    try {
                        const res = await apiFetch(`/api/updates/${id}`, { method: 'DELETE' })
                        if (res.ok) {
                            fetchUpdates()
                        } else {
                            alert('Failed to delete update')
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const openDeployUpdate = (upd) => {
                    selectedUpdate.value = upd
                    selectedClientIds.value = []
                    activeModal.value = 'deployUpdate'
                }

                const triggerDeploy = async () => {
                    if (!selectedUpdate.value || selectedClientIds.value.length === 0) return
                    
                    try {
                        const res = await apiFetch('/api/updates/trigger', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                update_id: selectedUpdate.value.id,
                                client_ids: selectedClientIds.value
                            })
                        })
                        
                        if (res.ok) {
                            const msg = await res.text()
                            alert(msg)
                            closeModal()
                        } else {
                            const txt = await res.text()
                            alert('Failed to trigger update: ' + txt)
                        }
                    } catch (e) {
                        alert(e.message)
                    }
                }

                const joinPath = (base, part) => {
                    if (base.endsWith('/') || base.endsWith('\\')) return base + part;
                    return base === '.' ? part : `${base}/${part}`;
                }

                const closeModal = () => {
                    activeModal.value = null
                    selectedClient.value = null
                }

                const formatBytes = (bytes, decimals = 2) => {
                    if (!+bytes) return '0 Bytes'
                    const k = 1024
                    const dm = decimals < 0 ? 0 : decimals
                    const sizes = ['Bytes', 'KiB', 'MiB', 'GiB', 'TiB']
                    const i = Math.floor(Math.log(bytes) / Math.log(k))
                    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`
                }

                // Spider Web Effect for Login Page
                const initSpiderWeb = () => {
                    const canvas = document.getElementById('login-canvas');
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');
                    let width, height;
                    let particles = [];
                    
                    const resize = () => {
                        width = canvas.width = window.innerWidth;
                        height = canvas.height = window.innerHeight;
                    };
                    
                    window.addEventListener('resize', resize);
                    resize();

                    const mouse = { x: null, y: null };
                    
                    canvas.addEventListener('mousemove', (e) => {
                        const rect = canvas.getBoundingClientRect();
                        mouse.x = e.clientX - rect.left;
                        mouse.y = e.clientY - rect.top;
                    });
                    
                    canvas.addEventListener('mouseleave', () => {
                        mouse.x = null;
                        mouse.y = null;
                    });

                    // Init particles
                    for (let i = 0; i < 80; i++) {
                        particles.push({
                            x: Math.random() * width,
                            y: Math.random() * height,
                            vx: (Math.random() - 0.5) * 1.5,
                            vy: (Math.random() - 0.5) * 1.5,
                            size: Math.random() * 3 + 1
                        });
                    }

                    const animate = () => {
                        if (!document.getElementById('login-canvas')) return;
                        
                        ctx.clearRect(0, 0, width, height);
                        
                        particles.forEach((p, index) => {
                            p.x += p.vx;
                            p.y += p.vy;

                            // Bounce
                            if (p.x < 0 || p.x > width) p.vx *= -1;
                            if (p.y < 0 || p.y > height) p.vy *= -1;

                            // Draw dot
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                            ctx.fillStyle = '#9ca3af'; // gray-400
                            ctx.fill();

                            // Connections between particles
                            for (let j = index + 1; j < particles.length; j++) {
                                const p2 = particles[j];
                                const dx = p.x - p2.x;
                                const dy = p.y - p2.y;
                                const dist = Math.sqrt(dx * dx + dy * dy);

                                if (dist < 150) {
                                    ctx.beginPath();
                                    ctx.strokeStyle = `rgba(156, 163, 175, ${1 - dist / 150})`;
                                    ctx.lineWidth = 0.5;
                                    ctx.moveTo(p.x, p.y);
                                    ctx.lineTo(p2.x, p2.y);
                                    ctx.stroke();
                                }
                            }
                            
                            // Mouse interaction
                            if (mouse.x != null) {
                                const dx = p.x - mouse.x;
                                const dy = p.y - mouse.y;
                                const dist = Math.sqrt(dx * dx + dy * dy);
                                if (dist < 200) {
                                     ctx.beginPath();
                                     ctx.strokeStyle = `rgba(37, 99, 235, ${1 - dist / 200})`; // blue-500
                                     ctx.lineWidth = 1;
                                     ctx.moveTo(p.x, p.y);
                                     ctx.lineTo(mouse.x, mouse.y);
                                     ctx.stroke();
                                     
                                     // Attraction
                                     const force = (200 - dist) / 200;
                                     if(dist > 50) {
                                         p.vx -= dx * force * 0.0005;
                                         p.vy -= dy * force * 0.0005;
                                     }
                                }
                            }
                        });

                        requestAnimationFrame(animate);
                    };

                    animate();
                };

                watch([authEnabled, isLoggedIn], async ([enabled, loggedIn]) => {
                    if (enabled && !loggedIn) {
                        await nextTick();
                        initSpiderWeb();
                    }
                }, { immediate: true });

                return {
                    clients, serverInfo, activeModal, selectedClient, commandLoading,
                    searchQuery, statusFilter, filteredClients,
                    hardwareInfo, shellInput, shellOutput, shellFileInput, shellOutputRef,
                    currentPath, fileList, fileInput,
                    openHardware, openShell, runShellCommand, triggerShellUpload, handleShellUpload,
                    openFiles, listFiles, 
                    triggerFileUpload, handleFileUpload, downloadFromClient, deleteClient,
                    openEditor, closeEditor, saveFile, editorFile, editorContent,
                    previewFile, previewUrl, previewType, previewContent, previewItems, docxContainer, previewLoading, openPreview, closePreview, openFileHandler,
                    openScripts, scriptList, selectedScript, isCreatingScript, newScript, scriptStatus,
                    openScriptEditor, saveScript, addStep, removeStep, deleteScript, openRunScript, executeScript,
                    fetchGroups, groupList, selectedGroup, isCreatingGroup, newGroup, openGroupEditor, saveGroup, deleteGroup, runGroupScripts,
                    fetchHistory, historyList, viewLogs, selectedLogs, clearHistory,
                    executionList, viewingExecutionId, viewingExecution,
                    selectedClientIds, currentView, fetchScripts,
                    updateList, selectedUpdate, newUpdate, updateFileInput, fetchUpdates, openUploadUpdateModal, uploadUpdate, deleteUpdate, openDeployUpdate, triggerDeploy,
                    closeModal, formatBytes, navigateUp, joinPath,
                    isMaximized, toggleMaximize, isMenuOpen, toggleMenu,
                    t, toggleLang, lang, formatDate,
                    currentLogItem, downloadLogFile, downloadArtifact,
                    // Auth exports
                    authEnabled, isLoggedIn, username, loginForm, passwordForm, showPasswordModal,
                    login, logout, changePassword
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
